<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beauty Clinic CRM v3.0 - Modern Style</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #333;
            font-size: 14px; /* Increased base font size */
        }

        .container {
            width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 15px 20px;
            border-bottom: 3px solid #dc3545;
            box-shadow: 0 2px 15px rgba(220, 53, 69, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #dc3545, #a71e2a);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .reminder-badge {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .nav-tabs {
            display: flex;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 0 20px;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            white-space: nowrap;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .nav-tab.active {
            border-bottom-color: #dc3545;
            color: #dc3545;
            background: white;
        }

        .main-content {
            padding: 30px;
        }
        
        .content-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
        }
        
        /* Modern Table Styles */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }
        
        .styled-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .styled-table thead tr {
            background-color: #dc3545;
            color: #ffffff;
            text-align: left;
        }

        .styled-table th,
        .styled-table td {
            padding: 12px 15px;
            white-space: nowrap;
        }
        
        .styled-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
        }

        .styled-table tbody tr:nth-of-type(even) {
            background-color: #f8f9fa;
        }

        .styled-table tbody tr:last-of-type {
            border-bottom: 2px solid #dc3545;
        }
        
        .styled-table tbody tr:hover {
            background-color: #fff3f4;
        }
        
        .editable {
            cursor: cell;
        }

        .editable:hover::after {
            content: " ‚úèÔ∏è";
            opacity: 0.7;
        }

        /* Status styling */
        .status-badge {
            font-weight: 600;
            text-align: center;
            color: white;
            border-radius: 12px;
            padding: 4px 10px;
            font-size: 12px;
            display: inline-block;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-action {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .btn-action:hover {
            transform: scale(1.1);
        }
        .btn-view { background-color: #17a2b8; }
        .btn-assign { background-color: #28a745; }
        .btn-archive { background-color: #ffc107; }
        .btn-delete { background-color: #dc3545; }


        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 4px solid #dc3545;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.15);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #212529;
            margin: 10px 0;
        }

        .quick-actions {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #212529;
            border-bottom: 2px solid #dc3545;
            padding-bottom: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 14px;
        }

        .form-input, .form-select {
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15);
        }

        .btn-primary {
            background: #dc3545;
            color: white;
            border: 1px solid #dc3545;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary:hover {
            background: #c82333;
            border-color: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: 1px solid #6c757d;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: #5a6268;
            border-color: #545b62;
        }

        /* Alert styles */
        .alert {
            padding: 12px 16px;
            border-radius: 3px;
            margin-bottom: 15px;
            font-weight: 600;
            position: relative;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success { background: #d1fae5; color: #059669; border: 1px solid #10b981; }
        .alert-error { background: #fee2e2; color: #dc2626; border: 1px solid #ef4444; }
        .alert-warning { background: #fef3cd; color: #856404; border: 1px solid #ffc107; }

        .alert .close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: inherit;
            font-weight: bold;
        }
        
        /* Login styles */
        .login-container {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #dc3545, #a71e2a);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .setup-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .step {
            margin-bottom: 30px;
            padding: 20px;
            border-left: 4px solid #dc3545;
            background: #f8f9fa;
            border-radius: 0 4px 4px 0;
        }

        .step h3 {
            color: #dc3545;
            margin-bottom: 15px;
        }

        /* Modal styles */
        .assign-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .assign-modal-content {
            background: white;
            padding: 30px;
            border-radius: 4px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .section { display: none; }
        .section.active { display: block; }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #dc3545;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .main-content { padding: 15px; }
            .stats-grid { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; gap: 15px; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999; width: 300px;"></div>

    <div id="setupGuide" class="login-container" style="display: none;">
        <div class="setup-container">
            <div class="logo-icon" style="margin: 0 auto 20px; width: 60px; height: 60px; font-size: 24px;">BC</div>
            <h1 style="color: #dc3545; margin-bottom: 10px;">Beauty Clinic CRM v3.0</h1>
            <p style="color: #6c757d; margin-bottom: 30px;">Modern Style - ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            
            <div class="step">
                <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á Supabase Project</h3>
                <ol>
                    <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="https://supabase.com" target="_blank">https://supabase.com</a></li>
                    <li>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</li>
                    <li>‡∏Ñ‡∏•‡∏¥‡∏Å "New Project"</li>
                    <li>‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Project: <code>beauty-clinic-crm-v3</code></li>
                    <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Region ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</li>
                    <li>‡∏Ñ‡∏•‡∏¥‡∏Å "Create new project"</li>
                </ol>
            </div>

            <div class="step">
                <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏£‡∏±‡∏ô SQL Schema</h3>
                <p>‡πÉ‡∏ô Supabase Dashboard ‡πÑ‡∏õ‡∏ó‡∏µ‡πà SQL Editor ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á SQL ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å</p>
                <p><strong>‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô SQL Schema ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ</p>
            </div>

            <div class="step">
                <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Authentication</h3>
                <ol>
                    <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà Authentication ‚Üí Settings</li>
                    <li>‡∏õ‡∏¥‡∏î "Enable email confirmations"</li>
                    <li>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Site URL</li>
                </ol>
            </div>

            <div class="step">
                <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏î‡∏∂‡∏á API Keys</h3>
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label class="form-label">Supabase URL</label>
                        <input type="url" class="form-input" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Supabase Anon Key</label>
                        <input type="text" class="form-input" id="supabaseAnonKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-primary" onclick="initializeSupabase()">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Supabase</button>
                </div>
            </div>
        </div>
    </div>

    <div class="login-container" id="loginContainer" style="display: none;">
        <div class="login-box">
            <div class="logo-icon" style="margin: 0 auto 20px; width: 60px; height: 60px; font-size: 24px;">BC</div>
            <h2 style="color: #dc3545; margin-bottom: 30px;">Beauty Clinic CRM v3.0</h2>
            <p style="color: #6c757d; margin-bottom: 20px;">Modern Style</p>
            
            <div id="loginForm">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                </div>
                <button class="btn-primary" onclick="signIn()" style="width: 100%; margin-bottom: 15px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button class="btn-secondary" onclick="showSignUp()" style="width: 100%;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</button>
            </div>

            <div id="signupForm" style="display: none;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" class="form-input" id="signupEmail" required>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" class="form-input" id="signupName" required>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" class="form-input" id="signupPassword" required>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                    <select class="form-select" id="signupRole">
                        <option value="Sales">Sales</option>
                        <option value="Admin">Admin</option>
                        <option value="Administrator">Administrator</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ã‡∏•‡∏•‡πå</label>
                    <select class="form-select" id="signupSalesCode">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô Sales --</option>
                        <option value="MAM">MAM</option>
                        <option value="AU">AU</option>
                        <option value="GOLF">GOLF</option>
                        <option value="Online">Online</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="signUp()" style="width: 100%; margin-bottom: 15px;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
                <button class="btn-secondary" onclick="showSignIn()" style="width: 100%;">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</button>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">BC</div>
                    <div>
                        <h1 style="font-size: 22px; font-weight: 700; color: #dc3545;">Beauty Clinic CRM v3.0</h1>
                        <p style="font-size: 14px; color: #6c757d;" id="userDisplayText">Modern Style</p>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-badge" id="userRoleBadge">Sales</div>
                    <div class="reminder-badge" onclick="showNotifications()" id="overdueNotification" style="display: none;">
                        ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î <span id="overdueCount">0</span>
                    </div>
                    <button class="btn-secondary" onclick="signOut()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
        </header>

        <nav class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('dashboard')">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
            <div class="nav-tab" onclick="showTab('customers')">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            <div class="nav-tab" id="addLeadTab" onclick="showTab('add-lead')" style="display: none;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏µ‡∏î</div>
            <div class="nav-tab" onclick="showTab('reports')">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
            <div class="nav-tab" id="myWorkTab" onclick="showTab('my-work')" style="display: none;">üìã ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
            <div class="nav-tab" onclick="showTab('alerts')">üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
        </nav>

        <main class="main-content">
            <div id="dashboard" class="section active">
                <div class="stats-grid" id="statsGrid"></div>
                <div class="quick-actions">
                    <h2 class="section-title">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;" id="quickActionButtons"></div>
                </div>
                <div class="quick-actions">
                    <h2 class="section-title">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                    <div id="recentActivity">
                        <div style="text-align: center; padding: 40px; color: #6c757d;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                    </div>
                </div>
            </div>

            <div id="add-lead" class="section">
                <div class="quick-actions">
                    <h2 class="section-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>
                    
                    <form id="leadForm" onsubmit="submitLead(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà *</label>
                                <input type="date" class="form-input" id="leadDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤ *</label>
                                <input type="time" class="form-input" id="leadTime" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ *</label>
                                <input type="text" class="form-input" id="customerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ *</label>
                                <input type="tel" class="form-input" id="customerPhone" placeholder="0xx-xxxxxxx" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á *</label>
                                <select class="form-select" id="leadChannel" required>
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á --</option>
                                    <option value="FBC-EYES">FBC-EYES / Inbox</option>
                                    <option value="FBH-Hair">FBH-Hair / Inbox</option>
                                    <option value="FBC By ‡∏´‡∏°‡∏≠‡∏ò‡∏µ‡∏£‡πå">FBC By ‡∏´‡∏°‡∏≠‡∏ò‡∏µ‡∏£‡πå</option>
                                    <option value="Walk-in">Walk-in</option>
                                    <option value="Referral">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ *</label>
                                <select class="form-select" id="procedureType" required>
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ --</option>
                                    <option value="‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏°">‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏°</option>
                                    <option value="‡∏ï‡∏≤‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå">‡∏ï‡∏≤‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå</option>
                                    <option value="‡∏à‡∏°‡∏π‡∏Å">‡∏à‡∏°‡∏π‡∏Å</option>
                                    <option value="‡∏¢‡∏Å‡∏Ñ‡∏¥‡πâ‡∏ß">‡∏¢‡∏Å‡∏Ñ‡∏¥‡πâ‡∏ß</option>
                                    <option value="‡∏â‡∏µ‡∏î‡∏ú‡∏¥‡∏ß">‡∏â‡∏µ‡∏î‡∏ú‡∏¥‡∏ß</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö *</label>
                                <select class="form-select" id="salesPerson" required>
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå --</option>
                                    <option value="MAM">MAM</option>
                                    <option value="AU">AU</option>
                                    <option value="GOLF">GOLF</option>
                                    <option value="Online">Online</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                                <input type="number" class="form-input" id="initialDeposit" placeholder="0" min="0">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                            <textarea class="form-input" id="leadNote" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                        </div>

                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" class="btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                            <button type="button" class="btn-secondary" onclick="resetForm()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="customers" class="section">
                <div class="content-card">
                    <h2 class="section-title">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
                    
                    <div class="form-row" style="margin-bottom: 25px;">
                        <div class="form-group">
                            <label class="form-label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                            <input type="text" class="form-input" id="searchCustomer" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå, ‡∏£‡∏´‡∏±‡∏™..." oninput="searchCustomers()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ã‡∏•‡∏•‡πå</label>
                            <select class="form-select" id="filterSales" onchange="loadCustomers()">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="MAM">MAM</option>
                                <option value="AU">AU</option>
                                <option value="GOLF">GOLF</option>
                                <option value="Online">Online</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                            <select class="form-select" id="filterStatus" onchange="loadCustomers()">
                            </select>
                        </div>
                    </div>

                    <div class="loading" id="customersLoading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

                    <div class="table-responsive">
                        <table class="styled-table" id="customerTable">
                            <thead>
                                <tr>
                                    <th>‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                    <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                                    <th>‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£</th>
                                    <th>‡∏°‡∏±‡∏î‡∏à‡∏≥</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î</th>
                                    <th>‡πÄ‡∏ã‡∏•‡∏•‡πå</th>
                                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="customerTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="my-work" class="section">
                <div class="content-card">
                    <h2 class="section-title">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</h2>
                    <div class="table-responsive">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                    <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
                                    <th>‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</th>
                                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="myWorkTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="reports" class="section">
                <div class="content-card">
                    <h2 class="section-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h2>
                    <div id="reportContent">
                        <div style="text-align: center; padding: 40px; color: #6c757d;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...</div>
                    </div>
                </div>
            </div>

            <div id="alerts" class="section">
                <div class="content-card">
                    <h2 class="section-title">‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h2>
                    <div id="alertsList">
                        <div style="text-align: center; padding: 40px; color: #6c757d;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="assign-modal" id="assignModal">
        <div class="assign-modal-content">
            <h3 class="section-title" style="border: none; padding-bottom: 0;">‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
            <div id="assignCustomerInfo" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;"></div>
            <div class="form-group">
                <label class="form-label">‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏•‡∏•‡πå</label>
                <select class="form-select" id="assignToSales">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå --</option>
                    <option value="MAM">MAM</option>
                    <option value="AU">AU</option>
                    <option value="GOLF">GOLF</option>
                    <option value="Online">Online</option>
                </select>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                <textarea class="form-input" id="assignNote" rows="3" placeholder="‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô..."></textarea>
            </div>
            <div style="text-align: center; margin-top: 20px; display:flex; gap: 10px;">
                <button class="btn-primary" onclick="confirmAssignWork()" style="flex:1;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                <button class="btn-secondary" onclick="closeAssignModal()" style="flex:1;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Global Variables
        let supabase = null;
        let currentUser = null;
        let currentProfile = null;
        let customers = [];
        let customerStatuses = [];
        let currentAssignCustomerId = null;

        // Excel editing variables
        let editingCell = null;
        let originalValue = null;
        let editingCustomerId = null;
        let editingField = null;
        let isEditingInProgress = false;

        const STATUS_WORKFLOW = {
            1: 2, 
            2: 3, 
            3: 4, 
            4: 5  
        };

        const EDITABLE_FIELDS = {
            0: { field: 'customer_code', type: 'text', label: '‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' },
            1: { field: 'name', type: 'text', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' },
            2: { field: 'phone', type: 'tel', label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£' },
            3: { field: 'procedure_type', type: 'select', label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£', 
                 options: ['‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏°', '‡∏ï‡∏≤‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå', '‡∏à‡∏°‡∏π‡∏Å', '‡∏¢‡∏Å‡∏Ñ‡∏¥‡πâ‡∏ß', '‡∏â‡∏µ‡∏î‡∏ú‡∏¥‡∏ß'] },
            4: { field: 'deposit', type: 'number', label: '‡∏°‡∏±‡∏î‡∏à‡∏≥' },
            5: { field: 'status', type: 'select', label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', options: 'status_list' },
            6: { field: 'note', type: 'textarea', label: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'},
            7: { field: 'appointment_date', type: 'date', label: '‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢' },
            8: { field: 'sales_person', type: 'select', label: '‡πÄ‡∏ã‡∏•‡∏•‡πå',
                 options: ['MAM', 'AU', 'GOLF', 'Online'] }
        };

        const PERMISSIONS = {
            Administrator: {
                canViewAll: true,
                canAssignWork: true,
                canManageDeposits: true,
                canAccessReports: true,
                canArchiveCustomers: true,
                canDeleteCustomers: true,
                displayName: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö'
            },
            Admin: {
                canViewAll: false,
                canAssignWork: true,
                canManageDeposits: true,
                canAccessReports: true,
                canArchiveCustomers: true,
                canDeleteCustomers: false,
                displayName: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'
            },
            Sales: {
                canViewAll: false,
                canAssignWork: false,
                canManageDeposits: true,
                canAccessReports: false,
                canArchiveCustomers: false,
                canDeleteCustomers: false,
                displayName: '‡πÄ‡∏ã‡∏•‡∏•‡πå'
            }
        };

        // Supabase Initialization
        async function initializeSupabase() {
            const supabaseUrl = document.getElementById('supabaseUrl').value.trim();
            const supabaseAnonKey = document.getElementById('supabaseAnonKey').value.trim();
            
            if (!supabaseUrl || !supabaseAnonKey) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Supabase URL ‡πÅ‡∏•‡∏∞ Anon Key', 'error');
                return;
            }

            try {
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                
                // Store in sessionStorage instead of localStorage
                sessionStorage.setItem('supabaseUrl', supabaseUrl);
                sessionStorage.setItem('supabaseAnonKey', supabaseAnonKey);
                
                await testConnection();
            } catch (error) {
                console.error('Supabase initialization error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase', 'error');
            }
        }

        async function testConnection() {
            try {
                const { data, error } = await supabase.from('profiles').select('count', { count: 'exact', head: true });
                
                if (error) {
                    console.error('Connection test error:', error);
                    showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Supabase ‡πÑ‡∏î‡πâ', 'error');
                    return;
                }
                
                await loadCustomerStatuses();
                
                showAlert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                document.getElementById('setupGuide').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
                
                checkAuthState();
            } catch (error) {
                console.error('Connection error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
            }
        }

        async function loadCustomerStatuses() {
            try {
                const { data, error } = await supabase
                    .from('customer_statuses')
                    .select('*')
                    .order('display_order');
                
                if (error) {
                    console.error('Load statuses error:', error);
                    customerStatuses = [
                        { id: 1, name: '‡∏•‡∏µ‡∏î‡πÉ‡∏´‡∏°‡πà', color: '#007bff' },
                        { id: 2, name: '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', color: '#ffc107' },
                        { id: 3, name: '‡∏™‡∏ô‡πÉ‡∏à/‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢', color: '#fd7e14' },
                        { id: 4, name: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏à‡∏£‡∏à‡∏≤', color: '#fd7e14' },
                        { id: 5, name: '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', color: '#28a745' },
                        { id: 6, name: '‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', color: '#dc3545' }
                    ];
                } else {
                    customerStatuses = data || [];
                }
                
                updateStatusFilter();
                console.log('Loaded customer statuses:', customerStatuses);
            } catch (error) {
                console.error('Error loading customer statuses:', error);
            }
        }

        function getStatusById(statusId) {
            return customerStatuses.find(s => s.id === statusId) || 
                   { id: statusId, name: '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö', color: '#6c757d' };
        }

        function updateStatusFilter() {
            const filterStatus = document.getElementById('filterStatus');
            if (filterStatus) {
                filterStatus.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
                
                customerStatuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.id;
                    option.textContent = status.name;
                    filterStatus.appendChild(option);
                });
            }
        }

        function generateCustomerCode() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const randomNum = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `BC${year}${month}${day}-${randomNum}`;
        }

        // Cell Editing Functions
        function startExcelEdit(cell, customerId, fieldIndex) {
            if (isEditingInProgress) {
                saveExcelEdit();
                return;
            }

            const fieldConfig = EDITABLE_FIELDS[fieldIndex];
            if (!fieldConfig) return;

            editingCell = cell;
            editingCustomerId = customerId;
            editingField = fieldConfig.field;
            isEditingInProgress = true;
            
            originalValue = cell.textContent.trim();
            
            if (fieldConfig.field === 'status') {
                const customer = customers.find(c => c.id === customerId);
                originalValue = customer ? customer.status : '';
            }
            if(fieldConfig.field === 'deposit') {
                 originalValue = originalValue.replace(/,/g, '');
            }

            cell.classList.add('editing');
            
            let inputElement;
            
            if (fieldConfig.type === 'select') {
                inputElement = document.createElement('select');
                inputElement.className = 'form-select';
                
                if (fieldConfig.options === 'status_list') {
                    customerStatuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status.id;
                        option.textContent = status.name;
                        option.selected = status.id == originalValue;
                        inputElement.appendChild(option);
                    });
                } else {
                    fieldConfig.options.forEach(optText => {
                        const option = document.createElement('option');
                        option.value = optText;
                        option.textContent = optText;
                        option.selected = optText === originalValue;
                        inputElement.appendChild(option);
                    });
                }
            } else if (fieldConfig.type === 'textarea') {
                inputElement = document.createElement('textarea');
                inputElement.className = 'form-input';
                inputElement.style.height = '60px';
                inputElement.style.resize = 'vertical';
            } else {
                inputElement = document.createElement('input');
                inputElement.type = fieldConfig.type;
                inputElement.className = 'form-input';
            }
            
            if (fieldConfig.type !== 'select') {
                inputElement.value = originalValue;
            }
            
            inputElement.addEventListener('blur', saveExcelEdit);
            inputElement.addEventListener('keydown', (e) => {
                e.stopPropagation();
                if (e.key === 'Enter' && fieldConfig.type !== 'textarea') {
                    e.preventDefault();
                    saveExcelEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelExcelEdit();
                }
            });

            cell.innerHTML = '';
            cell.appendChild(inputElement);
            inputElement.focus();
        }

        async function saveExcelEdit() {
            if (!isEditingInProgress) return;

            const inputElement = editingCell.querySelector('input, select, textarea');
            if (!inputElement) return;

            let newValue = inputElement.value.trim();

            if (editingField === 'status') {
                newValue = parseInt(newValue);
            } else if (editingField === 'deposit') {
                newValue = parseInt(newValue) || 0;
            }
            
            if (newValue.toString() === originalValue.toString()) {
                cancelExcelEdit();
                return;
            }
            
            const updateData = {
                [editingField]: newValue,
                updated_at: new Date().toISOString(),
                updated_by: currentUser.id
            };
            
            // Auto-note for status changes
            if (editingField === 'status') {
                const currentDate = new Date().toLocaleDateString('th-TH');
                const statusDef = getStatusById(newValue);
                const statusNote = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusDef.name} / ${currentDate}`;
                const customer = customers.find(c => c.id === editingCustomerId);
                updateData.note = (customer.note || '') + `\n${statusNote}`;
            }

            try {
                const { error } = await supabase
                    .from('customers')
                    .update(updateData)
                    .eq('id', editingCustomerId);

                if (error) {
                    showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                    cancelExcelEdit(); 
                } else {
                    showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success', 1500);
                    loadCustomers();
                    updateDashboard();
                }
            } catch (error) {
                console.error('Save error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
                cancelExcelEdit();
            }
            
            resetExcelEditState();
        }

        function cancelExcelEdit() {
            resetExcelEditState();
            loadCustomers();
        }

        function resetExcelEditState() {
            if (editingCell) {
                editingCell.classList.remove('editing');
            }
            editingCell = null;
            originalValue = null;
            editingCustomerId = null;
            editingField = null;
            isEditingInProgress = false;
        }

        // Authentication Functions
        async function signUp() {
            const email = document.getElementById('signupEmail').value.trim();
            const name = document.getElementById('signupName').value.trim();
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('signupRole').value;
            const salesCode = document.getElementById('signupSalesCode').value;

            if (!email || !name || !password || !role) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            if (password.length < 6) {
                showAlert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: name,
                            role: role,
                            sales_code: salesCode
                        }
                    }
                });

                if (error) {
                    console.error('Signup error:', error);
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                    return;
                }

                showAlert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                showSignIn();
            } catch (error) {
                console.error('Signup error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', 'error');
            }
        }

        async function signIn() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    console.error('Signin error:', error);
                    showAlert('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    return;
                }

                await loadUserProfile();
                showMainApp();
            } catch (error) {
                console.error('Signin error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
            }
        }

        async function signOut() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                currentProfile = null;
                customers = [];
                
                // Clear session storage
                sessionStorage.removeItem('supabaseUrl');
                sessionStorage.removeItem('supabaseAnonKey');
                
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
                showAlert('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                console.error('Signout error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'error');
            }
        }

        async function checkAuthState() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                await loadUserProfile();
                showMainApp();
            }
        }

        async function loadUserProfile() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) {
                    console.error('Profile load error:', error);
                    showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
                    return;
                }

                currentProfile = data;
                
                await supabase
                    .from('profiles')
                    .update({ last_login: new Date().toISOString() })
                    .eq('id', currentUser.id);
                    
            } catch (error) {
                console.error('Profile load error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå', 'error');
            }
        }

        function showSignUp() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
        }

        function showSignIn() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            
            if (currentProfile) {
                document.getElementById('userDisplayText').textContent = `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${currentProfile.name}`;
                document.getElementById('userRoleBadge').textContent = PERMISSIONS[currentProfile.role].displayName;
                
                setupUserInterface();
                loadCustomers();
                updateDashboard();
            }
        }

        function setupUserInterface() {
            const permissions = PERMISSIONS[currentProfile.role];
            
            if (permissions.canViewAll || currentProfile.role === 'Admin') {
                document.getElementById('addLeadTab').style.display = 'flex';
            } else {
                 document.getElementById('addLeadTab').style.display = 'none';
            }

            if(currentProfile.role === 'Sales') {
                document.getElementById('myWorkTab').style.display = 'flex';
            } else {
                document.getElementById('myWorkTab').style.display = 'none';
            }
            
            updateDashboardPermissions();
        }

        function updateDashboardPermissions() {
            const permissions = PERMISSIONS[currentProfile.role];
            const statsGrid = document.getElementById('statsGrid');
            const quickActions = document.getElementById('quickActionButtons');
            
            statsGrid.innerHTML = '';
            quickActions.innerHTML = '';
            
            if (permissions.canViewAll) {
                addStatCard('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'totalCustomers', '#17a2b8');
                addStatCard('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'todayLeads', '#28a745');
            }
            
            addStatCard('‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°', 'overdueLeads', '#dc3545');
            
            if (permissions.canAccessReports) {
                addStatCard('‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ', 'monthlySales', '#28a745');
                addStatCard('‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', 'conversionRate', '#17a2b8');
            }
            
            if (permissions.canViewAll || currentProfile.role === 'Admin') {
                addQuickAction('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà', 'showTab("add-lead")', 'btn-primary');
            }
            
            addQuickAction('‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'showTab("customers")', 'btn-secondary');
            
            if (permissions.canAccessReports) {
                addQuickAction('‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'showTab("reports")', 'btn-secondary');
            }
            
            addQuickAction('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'exportData()', 'btn-secondary');
        }

        function addStatCard(title, id, color) {
            const card = document.createElement('div');
            card.className = 'stat-card';
            card.innerHTML = `
                <div>${title}</div>
                <div class="stat-value" id="${id}">0</div>
                <div style="color: ${color}; min-height: 1em;"></div>
            `;
            document.getElementById('statsGrid').appendChild(card);
        }

        function addQuickAction(title, onclick, className) {
            const button = document.createElement('button');
            button.className = className;
            button.textContent = title;
            button.onclick = new Function(onclick);
            document.getElementById('quickActionButtons').appendChild(button);
        }

        // Lead Submission
        async function submitLead(event) {
            event.preventDefault();

            const formData = {
                customer_code: generateCustomerCode(),
                date: document.getElementById('leadDate').value,
                time: document.getElementById('leadTime').value,
                name: document.getElementById('customerName').value.trim(),
                phone: document.getElementById('customerPhone').value.trim(),
                channel: document.getElementById('leadChannel').value,
                procedure_type: document.getElementById('procedureType').value,
                sales_person: document.getElementById('salesPerson').value,
                status: 1,
                deposit: parseInt(document.getElementById('initialDeposit').value) || 0,
                note: document.getElementById('leadNote').value.trim(),
                created_by: currentUser.id,
                next_follow_up: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
            };

            if (!validateForm(formData)) {
                return;
            }

            const submitBtn = event.target.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            }

            try {
                const { data, error } = await supabase
                    .from('customers')
                    .insert([formData])
                    .select();

                if (error) {
                    console.error('Insert error:', error);
                    if (error.code === '23505') {
                        showAlert('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'error');
                    } else {
                        showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    }
                    return;
                }

                showAlert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "${formData.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                resetForm();
                loadCustomers();
                updateDashboard();
            } catch (error) {
                console.error('Submit error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                }
            }
        }

        function validateForm(data) {
            let isValid = true;

            if (!data.name || data.name.length < 2) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                isValid = false;
            }

            const phonePattern = /^[0-9\-\s\+\(\)]{9,15}$/;
            if (!phonePattern.test(data.phone)) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                isValid = false;
            }

            if (!data.date || new Date(data.date) > new Date()) {
                showAlert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï', 'error');
                isValid = false;
            }

            return isValid;
        }

        // Customer Loading and Rendering
        async function loadCustomers() {
            if (!currentProfile) return;
            const loadingEl = document.getElementById('customersLoading');
            if(loadingEl) loadingEl.style.display = 'block';
            
            try {
                let query = supabase.from('customers').select('*').eq('is_archived', false).order('created_at', { ascending: false });

                if (!PERMISSIONS[currentProfile.role].canViewAll) {
                    if (currentProfile.role === 'Admin') {
                        query = query.or(`status.eq.1,sales_person.eq.${currentProfile.sales_code || 'none'}`);
                    } else {
                        query = query.eq('sales_person', currentProfile.sales_code || 'none');
                    }
                }

                const salesFilter = document.getElementById('filterSales')?.value;
                if (salesFilter) {
                    query = query.eq('sales_person', salesFilter);
                }

                const statusFilter = document.getElementById('filterStatus')?.value;
                if (statusFilter) {
                    query = query.eq('status', parseInt(statusFilter));
                }

                const { data, error } = await query;

                if (error) {
                    console.error('Load customers error:', error);
                    showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
                    return;
                }

                customers = data || [];
                renderModernTable(customers);
            } catch (error) {
                console.error('Load customers error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            } finally {
                 if(loadingEl) loadingEl.style.display = 'none';
            }
        }

        function renderModernTable(data) {
            const tableBody = document.getElementById('customerTableBody');
            tableBody.innerHTML = '';

            if (data.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="10" style="text-align: center; padding: 40px; color: #6c757d;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</td>`;
                tableBody.appendChild(emptyRow);
                return;
            }

            const userPermissions = PERMISSIONS[currentProfile.role];

            data.forEach((customer, index) => {
                const row = document.createElement('tr');
                row.className = 'customer-row';
                
                const statusDef = getStatusById(customer.status);
                
                let actionButtons = `<button title="‡∏î‡∏π" onclick="viewCustomer('${customer.id}')" class="btn-action btn-view">D</button>`;
                if (userPermissions.canAssignWork) actionButtons += `<button title="‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" onclick="openAssignModal('${customer.id}')" class="btn-action btn-assign">A</button>`;
                if (userPermissions.canArchiveCustomers) actionButtons += `<button title="‡πÄ‡∏Å‡πá‡∏ö" onclick="archiveCustomer('${customer.id}')" class="btn-action btn-archive">C</button>`;
                if (userPermissions.canDeleteCustomers) actionButtons += `<button title="‡∏•‡∏ö" onclick="deleteCustomer('${customer.id}')" class="btn-action btn-delete">X</button>`;

                row.innerHTML = `
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 0)">${escapeHtml(customer.customer_code || 'BC-XXXX')}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 1)" style="font-weight: 600;">${escapeHtml(customer.name)}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 2)">${escapeHtml(customer.phone)}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 3)">${escapeHtml(customer.procedure_type)}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 4)">${(customer.deposit || 0).toLocaleString()}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 5)">
                        <span class="status-badge" style="background-color:${statusDef.color}; color: ${statusDef.color === '#ffc107' ? '#333' : 'white'}">${statusDef.name}</span>
                    </td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 6)" style="max-width: 200px; white-space: normal; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(customer.note || '')}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 7)">${escapeHtml(customer.appointment_date || '-')}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 8)">${escapeHtml(customer.sales_person)}</td>
                    <td>
                        <div class="action-buttons">${actionButtons}</div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }


        // Customer Management Functions
        async function archiveCustomer(customerId) {
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ? (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)')) {
                return;
            }

            const reason = prompt('‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:');
            if (!reason) return;

            try {
                const { error } = await supabase
                    .from('customers')
                    .update({
                        is_archived: true,
                        archived_at: new Date().toISOString(),
                        archived_by: currentUser.id,
                        archive_reason: reason
                    })
                    .eq('id', customerId);

                if (error) {
                    console.error('Archive customer error:', error);
                    showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                    return;
                }

                showAlert('‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                loadCustomers();
                updateDashboard();
            } catch (error) {
                console.error('Archive customer error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }

        async function deleteCustomer(customerId) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('customers')
                    .delete()
                    .eq('id', customerId);

                if (error) {
                    console.error('Delete customer error:', error);
                    showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                    return;
                }

                showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                loadCustomers();
                updateDashboard();
            } catch (error) {
                console.error('Delete customer error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }

        function openAssignModal(customerId) {
            if (!PERMISSIONS[currentProfile.role].canAssignWork) {
                showAlert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
                return;
            }

            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'error');
                return;
            }

            currentAssignCustomerId = customerId;
            
            document.getElementById('assignCustomerInfo').innerHTML = `
                <strong>${escapeHtml(customer.name)}</strong><br>
                ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${escapeHtml(customer.phone)}<br>
                ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£: ${escapeHtml(customer.procedure_type)}<br>
                ‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span style="color: #28a745; font-weight: 600;">${escapeHtml(customer.sales_person)}</span>
            `;

            document.getElementById('assignToSales').value = '';
            document.getElementById('assignNote').value = '';
            document.getElementById('assignModal').style.display = 'flex';
        }

        function closeAssignModal() {
            document.getElementById('assignModal').style.display = 'none';
            currentAssignCustomerId = null;
        }

        async function confirmAssignWork() {
            const newSales = document.getElementById('assignToSales').value;
            const assignNote = document.getElementById('assignNote').value.trim();

            if (!newSales) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ', 'warning');
                return;
            }

            if (!currentAssignCustomerId) {
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
                closeAssignModal();
                return;
            }

            try {
                const customer = customers.find(c => c.id === currentAssignCustomerId);
                if (!customer) {
                    showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'error');
                    closeAssignModal();
                    return;
                }

                const oldSales = customer.sales_person;
                const assignRecord = `\n[${new Date().toLocaleDateString()}] ‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å ${oldSales} ‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${newSales} ‡πÇ‡∏î‡∏¢ ${currentProfile.name}`;
                const updateNote = assignNote ? assignRecord + ` - ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${assignNote}` : assignRecord;

                const { error } = await supabase
                    .from('customers')
                    .update({
                        sales_person: newSales,
                        note: (customer.note || '') + updateNote,
                        updated_at: new Date().toISOString(),
                        updated_by: currentUser.id
                    })
                    .eq('id', currentAssignCustomerId);

                if (error) {
                    console.error('Assign work error:', error);
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
                    return;
                }

                showAlert(`‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô "${customer.name}" ‡∏à‡∏≤‡∏Å ${oldSales} ‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${newSales} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                closeAssignModal();
                loadCustomers();
            } catch (error) {
                console.error('Assign work error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
            }
        }

        // Dashboard and Reports
        async function updateDashboard() {
            if (!currentProfile) return;

            try {
                const today = new Date().toISOString().split('T')[0];
                const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];

                const { count: totalCount, error: totalErr } = await supabase.from('customers').select('*', { count: 'exact', head: true }).eq('is_archived', false);
                const { count: todayCount, error: todayErr } = await supabase.from('customers').select('*', { count: 'exact', head: true }).eq('date', today);
                const { count: overdueCount, error: overdueErr } = await supabase.from('customers').select('*', { count: 'exact', head: true }).lt('created_at', new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString()).neq('status', 5).eq('is_archived', false);
                const { data: salesData, error: salesErr } = await supabase.from('customers').select('total_amount, status').gte('created_at', firstDayOfMonth).eq('is_archived', false);

                if (totalErr || todayErr || overdueErr || salesErr) {
                    console.error('Dashboard query errors:', { totalErr, todayErr, overdueErr, salesErr });
                    return;
                }

                const monthlyRevenue = salesData.reduce((sum, deal) => sum + (deal.status === 5 ? deal.total_amount : 0), 0);
                const closedDealsThisMonth = salesData.filter(d => d.status === 5).length;
                const totalLeadsThisMonth = salesData.length;
                const conversionRate = totalLeadsThisMonth > 0 ? Math.round((closedDealsThisMonth / totalLeadsThisMonth) * 100) : 0;

                const elements = {
                    'totalCustomers': totalCount || 0,
                    'todayLeads': todayCount || 0,
                    'overdueLeads': overdueCount || 0,
                    'monthlySales': formatCurrency(monthlyRevenue),
                    'conversionRate': `${conversionRate}%`
                };

                for (const [id, value] of Object.entries(elements)) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                        const nextSibling = element.nextElementSibling;
                        if (nextSibling) {
                           nextSibling.textContent = ''; 
                        }
                    }
                }
                
                const overdueNotification = document.getElementById('overdueNotification');
                const overdueCountEl = document.getElementById('overdueCount');
                if (overdueCount > 0) {
                    overdueNotification.style.display = 'block';
                    overdueCountEl.textContent = overdueCount;
                } else {
                    overdueNotification.style.display = 'none';
                }
                
                if (customers.length > 0) {
                    updateRecentActivity();
                }

            } catch (error) {
                console.error('Update dashboard error:', error);
            }
        }

        function formatCurrency(amount) {
            if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'M';
            if (amount >= 1000) return (amount / 1000).toFixed(0) + 'K';
            return amount.toLocaleString();
        }

        function updateRecentActivity() {
            const recent = customers.slice().sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);
            const recentEl = document.getElementById('recentActivity');
            
            if (recent.length === 0) {
                recentEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>';
                return;
            }
            
            recentEl.innerHTML = '';
            recent.forEach(customer => {
                const statusDef = getStatusById(customer.status);
                
                const activityItem = document.createElement('div');
                activityItem.style.cssText = 'display: flex; align-items: center; gap: 15px; padding: 10px 0; border-bottom: 1px solid #f1f3f4;';
                
                activityItem.innerHTML = `
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #dc3545; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                        ${customer.name.charAt(0)}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${escapeHtml(customer.name)} - ${escapeHtml(customer.procedure_type)}</div>
                        <div style="font-size: 12px; color: #6c757d;">${escapeHtml(customer.phone)} | ${escapeHtml(customer.sales_person)}</div>
                    </div>
                    <span style="font-size: 12px; color: ${statusDef.color}; font-weight: 600;">${statusDef.name}</span>
                `;
                recentEl.appendChild(activityItem);
            });
        }

        // Navigation and UI Functions
        function showTab(tabName) {
            const sections = document.querySelectorAll('.section');
            const tabs = document.querySelectorAll('.nav-tab');
            
            sections.forEach(section => section.classList.remove('active'));
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            
            const tabNames = {
                'dashboard': '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°',
                'customers': '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 
                'add-lead': '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏µ‡∏î',
                'reports': '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                'my-work': '‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô',
                'alerts': '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'
            };
            
            const clickedTab = Array.from(tabs).find(tab => 
                tab.textContent.includes(tabNames[tabName])
            );
            
            if (clickedTab) clickedTab.classList.add('active');
            
            if (tabName === 'customers') loadCustomers();
            if (tabName === 'my-work') loadMyWork();
            if (tabName === 'reports') loadReports();
            if (tabName === 'alerts') loadAlerts();
        }

        function searchCustomers() {
            const searchTerm = document.getElementById('searchCustomer').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#customerTableBody tr.customer-row');
            
            rows.forEach(row => {
                const searchableText = row.textContent.toLowerCase();
                const isMatch = searchableText.includes(searchTerm);
                row.style.display = isMatch ? '' : 'none';
            });
        }

        async function loadMyWork() {
            if (!currentProfile?.sales_code) return;
            
            const myWorkBody = document.getElementById('myWorkTableBody');
            const myWork = customers.filter(customer => 
                customer.sales_person === currentProfile.sales_code && !customer.is_archived
            );
            
            myWorkBody.innerHTML = '';
            
            if (myWork.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</td>`;
                myWorkBody.appendChild(emptyRow);
                return;
            }

            myWork.forEach((customer, index) => {
                const statusDef = getStatusById(customer.status);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${customer.date}</td>
                    <td style="font-weight: 600;">${escapeHtml(customer.name)}</td>
                    <td>${escapeHtml(customer.phone)}</td>
                    <td>${escapeHtml(customer.procedure_type)}</td>
                    <td><span class="status-badge" style="background-color:${statusDef.color}; color: ${statusDef.color === '#ffc107' ? '#333' : 'white'}">${statusDef.name}</span></td>
                    <td>${customer.next_follow_up || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="viewCustomer('${customer.id}')" class="btn-action btn-view">D</button>
                            <button onclick="updateFollowUp('${customer.id}')" class="btn-action btn-assign">N</button>
                        </div>
                    </td>
                `;
                myWorkBody.appendChild(row);
            });
        }

        async function loadReports() {
            if (!currentProfile) return;
            const reportEl = document.getElementById('reportContent');
            
            if (!PERMISSIONS[currentProfile.role].canAccessReports) {
                reportEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>';
                return;
            }
            
            if (customers.length === 0) {
                reportEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>';
                return;
            }
            
            const totalLeads = customers.length;
            const closedDeals = customers.filter(c => c.status === 5).length;
            const totalRevenue = customers.reduce((sum, c) => sum + (c.total_amount || 0), 0);
            const conversionRate = totalLeads > 0 ? Math.round((closedDeals / totalLeads) * 100) : 0;
            
            reportEl.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div>‡∏•‡∏µ‡∏î‡∏£‡∏ß‡∏°</div>
                        <div class="stat-value">${totalLeads}</div>
                    </div>
                    <div class="stat-card">
                        <div>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                        <div class="stat-value">${closedDeals}</div>
                        <div style="color: #28a745;">‡∏≠‡∏±‡∏ï‡∏£‡∏≤ ${conversionRate}%</div>
                    </div>
                    <div class="stat-card">
                        <div>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
                        <div class="stat-value">${formatCurrency(totalRevenue)}</div>
                        <div style="color: #dc3545;">‡∏ö‡∏≤‡∏ó</div>
                    </div>
                </div>
            `;
        }

        async function loadAlerts() {
            if (!currentProfile) return;
            const alertsEl = document.getElementById('alertsList');
            
            const overdueCustomers = customers.filter(customer => {
                const daysOld = Math.floor((new Date() - new Date(customer.created_at)) / (1000 * 60 * 60 * 24));
                return daysOld > 45 && customer.status !== 5 && !customer.is_archived;
            });
            
            if (overdueCustomers.length === 0) {
                alertsEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô - ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏î‡∏µ!</div>';
                return;
            }
            
            alertsEl.innerHTML = '<h3 style="color: #dc3545;">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (‡πÄ‡∏Å‡∏¥‡∏ô 45 ‡∏ß‡∏±‡∏ô)</h3>' +
                overdueCustomers.map(customer => {
                    const daysOld = Math.floor((new Date() - new Date(customer.created_at)) / (1000 * 60 * 60 * 24));
                    return `
                        <div style="background: #fff5f5; border-left: 4px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 4px;">
                            <div style="font-weight: 600; color: #dc3545;">${escapeHtml(customer.name)} - ${escapeHtml(customer.procedure_type)}</div>
                            <div style="font-size: 12px; color: #6c757d;">‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${escapeHtml(customer.phone)} | ‡πÄ‡∏ã‡∏•‡∏•‡πå: ${escapeHtml(customer.sales_person)}</div>
                            <div style="font-size: 12px; color: #dc3545; margin-top: 5px;">‡∏Ñ‡πâ‡∏≤‡∏á ${daysOld} ‡∏ß‡∏±‡∏ô</div>
                            <button onclick="viewCustomer('${customer.id}')" class="btn-primary" style="margin-top: 10px; padding: 5px 10px; font-size: 12px;">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                        </div>
                    `;
                }).join('');
        }

        function viewCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'error');
                return;
            }
            
            const daysOld = Math.floor((new Date() - new Date(customer.created_at)) / (1000 * 60 * 60 * 24));
            const statusDef = getStatusById(customer.status);
            
            const details = 
                `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤\n\n` +
                `‡∏ä‡∏∑‡πà‡∏≠: ${customer.name}\n` +
                `‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${customer.phone}\n` +
                `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${customer.date} ${customer.time}\n` +
                `‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á: ${customer.channel}\n` +
                `‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£: ${customer.procedure_type}\n` +
                `‡πÄ‡∏ã‡∏•‡∏•‡πå: ${customer.sales_person}\n` +
                `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusDef.name}\n` +
                `‡∏°‡∏±‡∏î‡∏à‡∏≥: ${(customer.deposit || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó\n` +
                `‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢: ${(customer.total_amount || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó\n` +
                `‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${daysOld} ‡∏ß‡∏±‡∏ô\n` +
                `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°: ${customer.next_follow_up || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î'}\n` +
                `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${customer.note || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}`;
            
            alert(details);
        }

        async function updateFollowUp(customerId) {
            const newDate = prompt('‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà (YYYY-MM-DD):');
            if (!newDate) return;
            
            try {
                const { error } = await supabase
                    .from('customers')
                    .update({ 
                        next_follow_up: newDate,
                        updated_at: new Date().toISOString(),
                        updated_by: currentUser.id
                    })
                    .eq('id', customerId);

                if (error) {
                    console.error('Update follow-up error:', error);
                    showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', 'error');
                    return;
                }

                showAlert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                loadMyWork();
            } catch (error) {
                console.error('Update follow-up error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            }
        }

        function showNotifications() {
            showTab('alerts');
        }

        function exportData() {
            try {
                const dataToExport = PERMISSIONS[currentProfile.role].canViewAll ? customers : 
                                   customers.filter(c => c.sales_person === currentProfile.sales_code);
                
                const csvHeader = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏ä‡∏∑‡πà‡∏≠,‡πÄ‡∏ö‡∏≠‡∏£‡πå,‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á,‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£,‡πÄ‡∏ã‡∏•‡∏•‡πå,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞,‡∏°‡∏±‡∏î‡∏à‡∏≥,‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏\n';
                
                let csvContent = csvHeader;
                dataToExport.forEach(customer => {
                    const statusDef = getStatusById(customer.status);
                    const note = (customer.note || '').replace(/"/g, '""').replace(/\n/g, ' ');
                    csvContent += 
                        `${customer.date},"${customer.name}","${customer.phone}","${customer.channel}",` +
                        `"${customer.procedure_type}","${customer.sales_person}","${statusDef.name}",` +
                        `${customer.deposit || 0},${customer.total_amount || 0},"${note}"\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `beauty_clinic_data_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert(`‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${dataToExport.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }

        function resetForm() {
            document.getElementById('leadForm').reset();
            
            const now = new Date();
            document.getElementById('leadDate').value = now.toISOString().split('T')[0];
            document.getElementById('leadTime').value = now.toTimeString().slice(0, 5);
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        function showAlert(message, type = 'success', duration = 5000) {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;
            const alertId = 'alert-' + Date.now();
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.id = alertId;
            
            const messageEl = document.createElement('span');
            messageEl.textContent = message;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            };
            
            alert.appendChild(messageEl);
            alert.appendChild(closeBtn);
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                const el = document.getElementById(alertId);
                if (el) el.remove();
            }, duration);
        }

        // Event Listeners and Initialization
        window.onload = function() {
            // Check for saved credentials
            const savedUrl = sessionStorage.getItem('supabaseUrl');
            const savedKey = sessionStorage.getItem('supabaseAnonKey');
            
            if (savedUrl && savedKey) {
                document.getElementById('supabaseUrl').value = savedUrl;
                document.getElementById('supabaseAnonKey').value = savedKey;
                initializeSupabase();
            } else {
                document.getElementById('setupGuide').style.display = 'flex';
            }
            
            // Set default date and time
            const now = new Date();
            const leadDate = document.getElementById('leadDate');
            const leadTime = document.getElementById('leadTime');
            
            if (leadDate) leadDate.value = now.toISOString().split('T')[0];
            if (leadTime) leadTime.value = now.toTimeString().slice(0, 5);

            // Global click handler for Excel editing
            document.addEventListener('click', (e) => {
                if (isEditingInProgress && editingCell && !editingCell.contains(e.target)) {
                    if (!e.target.closest('button, a, select, input, .assign-modal')) {
                        setTimeout(() => {
                            if (isEditingInProgress && editingCell && !editingCell.querySelector('input:focus, select:focus, textarea:focus')) {
                                saveExcelEdit();
                            }
                        }, 100);
                    }
                }
            });

            // Global keydown handler for Excel editing
            document.addEventListener('keydown', (e) => {
                if (isEditingInProgress && (e.key === 'Enter' || e.key === 'Escape')) {
                    e.stopPropagation();
                }
            });

            // Handle modal clicks
            document.getElementById('assignModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('assignModal')) {
                    closeAssignModal();
                }
            });
        };

        // Advance status function for quick actions
        async function advanceStatus(customerId, currentStatusId) {
            if (!currentUser) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏', 'error');
                signOut();
                return;
            }

            const nextStatusId = STATUS_WORKFLOW[currentStatusId];
            if (!nextStatusId) {
                showAlert('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'warning');
                return;
            }

            try {
                const { error } = await supabase
                    .from('customers')
                    .update({ 
                        status: nextStatusId,
                        updated_at: new Date().toISOString(),
                        updated_by: currentUser.id
                     })
                    .eq('id', customerId);
                
                if (error) throw error;

                showAlert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success', 2000);
                
                loadCustomers();
                updateDashboard();

            } catch(error) {
                console.error('Advance status error:', error);
                showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${error.message}`, 'error');
            }
        }

        // Supabase auth state listener
        if (typeof window.supabase !== 'undefined') {
            // This will be called when supabase is loaded
            setTimeout(() => {
                if (supabase) {
                    supabase.auth.onAuthStateChange((event, session) => {
                        if (event === 'SIGNED_OUT') {
                            currentUser = null;
                            currentProfile = null;
                            customers = [];
                            document.getElementById('mainContainer').style.display = 'none';
                            document.getElementById('loginContainer').style.display = 'flex';
                        }
                    });
                }
            }, 1000);
        }
    </script>
</body>
</html>
}
