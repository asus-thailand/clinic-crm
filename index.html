<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beauty Clinic CRM v3.2 - Fixed & Enhanced Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #333;
            font-size: 14px;
        }

        .container {
            width: 100%;
            margin: 0;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 15px 20px;
            border-bottom: 3px solid #dc3545;
            box-shadow: 0 2px 15px rgba(220, 53, 69, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #dc3545, #a71e2a);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .reminder-badge {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .nav-tabs {
            display: flex;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 0 20px;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            white-space: nowrap;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .nav-tab.active {
            border-bottom-color: #dc3545;
            color: #dc3545;
            background: white;
        }

        .main-content {
            padding: 30px;
        }
        
        .content-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
        }
        
        /* Modern Table Styles */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            position: relative;
        }
        
        .styled-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            position: relative;
        }
        
        .styled-table thead tr {
            background-color: #dc3545;
            color: #ffffff;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .styled-table th,
        .styled-table td {
            padding: 12px 15px;
            white-space: nowrap;
            border-right: 1px solid #e9ecef;
        }
        
        .styled-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }
        
        .styled-table tbody tr.customer-row:hover {
            background-color: #fff3f4;
            cursor: pointer;
        }
        
        .styled-table tbody tr.active-row {
            background-color: #ffe8e9;
            font-weight: 600;
        }
        
        .editable {
            cursor: cell;
            position: relative;
        }

        .editable:hover::after {
            content: " ✏️";
            opacity: 0.7;
        }

        .editing {
            background-color: #fff9c4 !important;
            position: relative;
        }

        .editing input,
        .editing select,
        .editing textarea {
            width: 100%;
            min-width: 120px;
            border: 2px solid #dc3545;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            font-family: inherit;
        }

        /* Status styling */
        .status-badge {
            font-weight: 600;
            text-align: center;
            color: white;
            border-radius: 12px;
            padding: 4px 10px;
            font-size: 12px;
            display: inline-block;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-action {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .btn-action:hover {
            transform: scale(1.1);
        }

        .btn-view { background-color: #17a2b8; }
        .btn-assign { background-color: #28a745; }
        .btn-archive { background-color: #ffc107; }
        .btn-delete { background-color: #dc3545; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 4px solid #dc3545;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.15);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #212529;
            margin: 10px 0;
        }

        .quick-actions {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #212529;
            border-bottom: 2px solid #dc3545;
            padding-bottom: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 14px;
        }

        .form-label.required::after {
            content: " *";
            color: #dc3545;
        }

        .form-input, .form-select {
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15);
        }

        .form-input.error {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .form-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .btn-primary {
            background: #dc3545;
            color: white;
            border: 1px solid #dc3545;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary:hover:not(:disabled) {
            background: #c82333;
            border-color: #c82333;
        }

        .btn-primary:disabled {
            background: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: 1px solid #6c757d;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: #5a6268;
            border-color: #545b62;
        }

        /* Alert styles */
        .alert {
            padding: 12px 16px;
            border-radius: 3px;
            margin-bottom: 15px;
            font-weight: 600;
            position: relative;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success { background: #d1fae5; color: #059669; border: 1px solid #10b981; }
        .alert-error { background: #fee2e2; color: #dc2626; border: 1px solid #ef4444; }
        .alert-warning { background: #fef3cd; color: #856404; border: 1px solid #ffc107; }
        .alert-info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }

        .alert .close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: inherit;
            font-weight: bold;
        }
        
        /* Login styles */
        .login-container {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #dc3545, #a71e2a);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .setup-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .step {
            margin-bottom: 30px;
            padding: 20px;
            border-left: 4px solid #dc3545;
            background: #f8f9fa;
            border-radius: 0 4px 4px 0;
        }

        .step h3 {
            color: #dc3545;
            margin-bottom: 15px;
        }

        /* Modal styles */
        .assign-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .assign-modal-content {
            background: white;
            padding: 30px;
            border-radius: 4px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .section { 
            display: none; 
        }
        
        .section.active { 
            display: block; 
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading.active {
            display: block;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #dc3545;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Pagination styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px 0;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: #e9ecef;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .pagination-info {
            font-size: 14px;
            color: #6c757d;
            margin: 0 15px;
        }

        /* Advanced Search */
        .search-filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .search-filters.collapsed {
            padding: 10px 20px;
        }

        .search-toggle {
            background: none;
            border: none;
            color: #dc3545;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        /* Audit Trail */
        .audit-trail {
            background: #f8f9fa;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 4px 4px 0;
            font-size: 12px;
        }

        .audit-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .audit-entry:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .audit-timestamp {
            color: #6c757d;
            font-weight: 600;
        }

        .audit-user {
            color: #28a745;
            font-weight: 600;
        }

        .audit-action {
            color: #dc3545;
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ffc107;
            color: #856404;
            padding: 10px 15px;
            border-radius: 25px;
            font-weight: 600;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* Session Warning */
        .session-warning {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px 20px;
            border-radius: 4px;
            display: none;
            z-index: 1001;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            max-width: 300px;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .main-content { 
                padding: 15px; 
            }
            
            .stats-grid { 
                grid-template-columns: 1fr; 
            }
            
            .header-content { 
                flex-direction: column; 
                gap: 15px; 
            }
            
            .form-row { 
                grid-template-columns: 1fr; 
            }

            .styled-table {
                font-size: 12px;
            }

            .styled-table th,
            .styled-table td {
                padding: 8px 5px;
            }

            /* Hide less important columns on mobile */
            .styled-table th:nth-child(4),
            .styled-table td:nth-child(4),
            .styled-table th:nth-child(7),
            .styled-table td:nth-child(7) {
                display: none;
            }

            .nav-tabs {
                overflow-x: auto;
                padding: 0 10px;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 12px;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
            }

            .search-filters {
                padding: 15px;
            }

            .filter-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .pagination {
                flex-wrap: wrap;
                gap: 5px;
            }

            .pagination button {
                padding: 6px 10px;
                font-size: 12px;
            }

            .action-buttons {
                gap: 3px;
            }

            .btn-action {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 10px;
            }

            .styled-table th,
            .styled-table td {
                padding: 6px 3px;
                font-size: 11px;
            }

            /* Show only essential columns on very small screens */
            .styled-table th:nth-child(3),
            .styled-table td:nth-child(3),
            .styled-table th:nth-child(5),
            .styled-table td:nth-child(5),
            .styled-table th:nth-child(8),
            .styled-table td:nth-child(8) {
                display: none;
            }

            .pagination-info {
                font-size: 12px;
            }

            .stat-value {
                font-size: 22px;
            }
        }

        /* Print styles */
        @media print {
            .header, .nav-tabs, .action-buttons, .btn-primary, .btn-secondary {
                display: none;
            }
            
            .main-content {
                padding: 0;
            }
            
            .styled-table {
                font-size: 10pt;
                page-break-inside: auto;
            }
            
            .styled-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999; width: 300px;"></div>
    
    <div class="offline-indicator" id="offlineIndicator">
        ⚠️ ออฟไลน์ - บางฟีเจอร์อาจไม่ทำงาน
    </div>

    <div class="session-warning" id="sessionWarning">
        ⏰ เซสชันใกล้หมดอายุ - กรุณาบันทึกงานของคุณ
    </div>

    <div id="setupGuide" class="login-container" style="display: none;">
        <div class="setup-container">
            <div class="logo-icon" style="margin: 0 auto 20px; width: 60px; height: 60px; font-size: 24px;">BC</div>
            <h1 style="color: #dc3545; margin-bottom: 10px;">Beauty Clinic CRM v3.2</h1>
            <p style="color: #6c757d; margin-bottom: 30px;">Fixed & Enhanced Version - ระบบพร้อมใช้งาน</p>
            
            <div class="step">
                <h3>ขั้นตอนที่ 1: สร้าง Supabase Project</h3>
                <ol>
                    <li>ไปที่ <a href="https://supabase.com" target="_blank">https://supabase.com</a></li>
                    <li>สมัครสมาชิกและล็อกอิน</li>
                    <li>คลิก "New Project"</li>
                    <li>ตั้งชื่อ Project: <code>beauty-clinic-crm-v3</code></li>
                    <li>เลือก Region ที่ใกล้ที่สุด (Singapore สำหรับประเทศไทย)</li>
                    <li>คลิก "Create new project"</li>
                </ol>
            </div>

            <div class="step">
                <h3>ขั้นตอนที่ 2: รัน SQL Schema</h3>
                <p>ใน Supabase Dashboard ไปที่ SQL Editor และรันคำสั่ง SQL ที่ให้ไว้แยกต่างหาก</p>
                <p><strong>สำคัญ</strong>: ต้องรัน SQL Schema ให้เสร็จก่อนถึงจะใช้งานระบบนี้ได้</p>
            </div>

            <div class="step">
                <h3>ขั้นตอนที่ 3: ตั้งค่า Authentication</h3>
                <ol>
                    <li>ไปที่ Authentication → Settings</li>
                    <li>ปิด "Enable email confirmations" (สำหรับ development)</li>
                    <li>ตั้งค่า Site URL เป็น URL ที่จะใช้งาน</li>
                </ol>
            </div>

            <div class="step">
                <h3>ขั้นตอนที่ 4: ดึง API Keys</h3>
                <p style="color: #dc3545; margin-bottom: 15px;">⚠️ คำเตือน: อย่าแชร์ API Keys กับผู้อื่น</p>
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label class="form-label required">Supabase URL</label>
                        <input type="url" class="form-input" id="supabaseUrl" placeholder="https://xxxxx.supabase.co" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Supabase Anon Key</label>
                        <input type="text" class="form-input" id="supabaseAnonKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." required>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-primary" onclick="initializeSupabase()">เชื่อมต่อกับ Supabase</button>
                </div>
            </div>
        </div>
    </div>

    <div class="login-container" id="loginContainer" style="display: none;">
        <div class="login-box">
            <div class="logo-icon" style="margin: 0 auto 20px; width: 60px; height: 60px; font-size: 24px;">BC</div>
            <h2 style="color: #dc3545; margin-bottom: 30px;">Beauty Clinic CRM v3.2</h2>
            <p style="color: #6c757d; margin-bottom: 20px;">Fixed & Enhanced Version</p>
            
            <div id="loginForm">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">อีเมล</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="your@email.com" required autocomplete="email">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label">รหัสผ่าน</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="รหัสผ่าน" required autocomplete="current-password">
                </div>
                <button class="btn-primary" onclick="signIn()" style="width: 100%; margin-bottom: 15px;">เข้าสู่ระบบ</button>
                <button class="btn-secondary" onclick="showSignUp()" style="width: 100%;">สร้างบัญชีใหม่</button>
            </div>

            <div id="signupForm" style="display: none;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label required">อีเมล</label>
                    <input type="email" class="form-input" id="signupEmail" required autocomplete="email">
                    <div class="form-error" id="emailError"></div>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label required">ชื่อ-นามสกุล</label>
                    <input type="text" class="form-input" id="signupName" required autocomplete="name">
                    <div class="form-error" id="nameError"></div>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label required">รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)</label>
                    <input type="password" class="form-input" id="signupPassword" required autocomplete="new-password">
                    <div class="form-error" id="passwordError"></div>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">ตำแหน่ง</label>
                    <select class="form-select" id="signupRole">
                        <option value="Sales">Sales</option>
                        <option value="Admin">Admin</option>
                        <option value="Administrator">Administrator</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label">รหัสเซลล์</label>
                    <select class="form-select" id="signupSalesCode">
                        <option value="">-- เลือกหากเป็น Sales --</option>
                        <option value="MAM">MAM</option>
                        <option value="AU">AU</option>
                        <option value="GOLF">GOLF</option>
                        <option value="Online">Online</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="signUp()" style="width: 100%; margin-bottom: 15px;">สร้างบัญชี</button>
                <button class="btn-secondary" onclick="showSignIn()" style="width: 100%;">กลับไปล็อกอิน</button>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">BC</div>
                    <div>
                        <h1 style="font-size: 22px; font-weight: 700; color: #dc3545;">Beauty Clinic CRM v3.2</h1>
                        <p style="font-size: 14px; color: #6c757d;" id="userDisplayText">Fixed & Enhanced Version</p>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-badge" id="userRoleBadge">Sales</div>
                    <div class="reminder-badge" onclick="showNotifications()" id="overdueNotification" style="display: none;">
                        เกินกำหนด <span id="overdueCount">0</span>
                    </div>
                    <button class="btn-secondary" onclick="signOut()">ออกจากระบบ</button>
                </div>
            </div>
        </header>

        <nav class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('dashboard')">📊 ภาพรวม</div>
            <div class="nav-tab" onclick="showTab('customers')">👥 ลูกค้า</div>
            <div class="nav-tab" id="addLeadTab" onclick="showTab('add-lead')" style="display: none;">➕ เพิ่มลีด</div>
            <div class="nav-tab" onclick="showTab('reports')">📈 รายงาน</div>
            <div class="nav-tab" id="myWorkTab" onclick="showTab('my-work')" style="display: none;">📋 งานของฉัน</div>
            <div class="nav-tab" onclick="showTab('alerts')">🔔 แจ้งเตือน</div>
            <div class="nav-tab" onclick="showTab('audit')">📜 ประวัติการเปลี่ยนแปลง</div>
        </nav>

        <main class="main-content">
            <div id="dashboard" class="section active">
                <div class="stats-grid" id="statsGrid"></div>
                <div class="quick-actions">
                    <h2 class="section-title">การทำงานด่วน</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;" id="quickActionButtons"></div>
                </div>
                <div class="quick-actions">
                    <h2 class="section-title">กิจกรรมล่าสุด</h2>
                    <div id="recentActivity">
                        <div style="text-align: center; padding: 40px; color: #6c757d;">กำลังโหลดข้อมูล...</div>
                    </div>
                </div>
            </div>

            <div id="add-lead" class="section">
                <div class="quick-actions">
                    <h2 class="section-title">เพิ่มลูกค้าใหม่</h2>
                    
                    <form id="leadForm" onsubmit="submitLead(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">วันที่</label>
                                <input type="date" class="form-input" id="leadDate" required>
                                <div class="form-error" id="dateError"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">เวลา</label>
                                <input type="time" class="form-input" id="leadTime" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">ชื่อลูกค้า</label>
                                <input type="text" class="form-input" id="customerName" placeholder="ชื่อ-สกุล" required>
                                <div class="form-error" id="nameError"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">เบอร์ติดต่อ</label>
                                <input type="tel" class="form-input" id="customerPhone" placeholder="0xx-xxxxxxx" required pattern="[0-9\-\+\(\)\s]{9,15}">
                                <div class="form-error" id="phoneError"></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">ช่องทาง</label>
                                <select class="form-select" id="leadChannel" required>
                                    <option value="">-- เลือกช่องทาง --</option>
                                    <option value="FBC-EYES">FBC-EYES / Inbox</option>
                                    <option value="FBH-Hair">FBH-Hair / Inbox</option>
                                    <option value="FBC By หมอธีร์">FBC By หมอธีร์</option>
                                    <option value="Walk-in">Walk-in</option>
                                    <option value="Referral">แนะนำจากเพื่อน</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">ประเภทหัตถการ</label>
                                <select class="form-select" id="procedureType" required>
                                    <option value="">-- เลือกหัตถการ --</option>
                                    <option value="ปลูกผม">ปลูกผม</option>
                                    <option value="ตาทีมแพทย์">ตาทีมแพทย์</option>
                                    <option value="จมูก">จมูก</option>
                                    <option value="ยกคิ้ว">ยกคิ้ว</option>
                                    <option value="ฉีดผิว">ฉีดผิว</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">เซลล์ผู้รับผิดชอบ</label>
                                <select class="form-select" id="salesPerson" required>
                                    <option value="">-- เลือกเซลล์ --</option>
                                    <option value="MAM">MAM</option>
                                    <option value="AU">AU</option>
                                    <option value="GOLF">GOLF</option>
                                    <option value="Online">Online</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">มัดจำเริ่มต้น</label>
                                <input type="number" class="form-input" id="initialDeposit" placeholder="0" min="0" max="999999999">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">หมายเหตุ</label>
                            <textarea class="form-input" id="leadNote" rows="3" placeholder="รายละเอียดเพิ่มเติม..." maxlength="1000"></textarea>
                        </div>

                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" class="btn-primary" id="submitBtn">บันทึกข้อมูล</button>
                            <button type="button" class="btn-secondary" onclick="resetForm()">ล้างข้อมูล</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="customers" class="section">
                <div class="content-card">
                    <h2 class="section-title">รายชื่อลูกค้า</h2>
                    
                    <div class="search-filters" id="searchFilters">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0;">ค้นหาและกรอง</h4>
                            <button class="search-toggle" onclick="toggleSearchFilters()">🔽 ซ่อน/แสดง</button>
                        </div>
                        
                        <div class="filter-grid" id="filterGrid">
                            <div class="form-group">
                                <label class="form-label">ค้นหา</label>
                                <input type="text" class="form-input" id="searchCustomer" placeholder="ค้นหาชื่อ, เบอร์, รหัส..." oninput="debounceSearch()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">กรองตามเซลล์</label>
                                <select class="form-select" id="filterSales" onchange="loadCustomers()">
                                    <option value="">ทั้งหมด</option>
                                    <option value="MAM">MAM</option>
                                    <option value="AU">AU</option>
                                    <option value="GOLF">GOLF</option>
                                    <option value="Online">Online</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">กรองตามสถานะ</label>
                                <select class="form-select" id="filterStatus" onchange="loadCustomers()">
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ช่วงวันที่</label>
                                <input type="date" class="form-input" id="filterDateFrom" onchange="loadCustomers()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ถึงวันที่</label>
                                <input type="date" class="form-input" id="filterDateTo" onchange="loadCustomers()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ช่องทาง</label>
                                <select class="form-select" id="filterChannel" onchange="loadCustomers()">
                                    <option value="">ทั้งหมด</option>
                                    <option value="FBC-EYES">FBC-EYES</option>
                                    <option value="FBH-Hair">FBH-Hair</option>
                                    <option value="FBC By หมอธีร์">FBC By หมอธีร์</option>
                                    <option value="Walk-in">Walk-in</option>
                                    <option value="Referral">Referral</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn-secondary" onclick="clearFilters()">ล้างการกรอง</button>
                            <button class="btn-primary" onclick="loadCustomers()">ค้นหา</button>
                        </div>
                    </div>

                    <div class="loading" id="customersLoading">กำลังโหลดข้อมูล...</div>

                    <div class="table-responsive">
                        <table class="styled-table" id="customerTable">
                            <thead>
                                <tr>
                                    <th>รหัสลูกค้า</th>
                                    <th>ชื่อลูกค้า</th>
                                    <th>เบอร์</th>
                                    <th>หัตถการ</th>
                                    <th>มัดจำ</th>
                                    <th>สถานะ</th>
                                    <th>วันนัด</th>
                                    <th>เซลล์</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="customerTableBody">
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination" id="pagination">
                        <button onclick="goToPage(1)" id="firstPage">⏮️</button>
                        <button onclick="goToPage(currentPage - 1)" id="prevPage">⬅️</button>
                        <div class="pagination-info">
                            หน้า <span id="currentPageSpan">1</span> จาก <span id="totalPagesSpan">1</span>
                            (ทั้งหมด <span id="totalRecordsSpan">0</span> รายการ)
                        </div>
                        <button onclick="goToPage(currentPage + 1)" id="nextPage">➡️</button>
                        <button onclick="goToPage(totalPages)" id="lastPage">⏭️</button>
                    </div>
                </div>
            </div>

            <div id="my-work" class="section">
                <div class="content-card">
                    <h2 class="section-title">งานที่ได้รับมอบหมาย</h2>
                    <div class="table-responsive">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>วันที่รับงาน</th>
                                    <th>ชื่อลูกค้า</th>
                                    <th>เบอร์</th>
                                    <th>หัตถการ</th>
                                    <th>สถานะปัจจุบัน</th>
                                    <th>วันที่ต้องติดตาม</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="myWorkTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="reports" class="section">
                <div class="content-card">
                    <h2 class="section-title">รายงานและสถิติ</h2>
                    <div id="reportContent">
                        <div style="text-align: center; padding: 40px; color: #6c757d;">กำลังโหลดรายงาน...</div>
                    </div>
                </div>
            </div>

            <div id="alerts" class="section">
                <div class="content-card">
                    <h2 class="section-title">เคสที่ต้องติดตาม</h2>
                    <div id="alertsList">
                        <div style="text-align: center; padding: 40px; color: #6c757d;">กำลังโหลดการแจ้งเตือน...</div>
                    </div>
                </div>
            </div>

            <div id="audit" class="section">
                <div class="content-card">
                    <h2 class="section-title">ประวัติการเปลี่ยนแปลงข้อมูล</h2>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">กรองตามผู้ใช้</label>
                            <select class="form-select" id="auditUserFilter" onchange="loadAuditTrail()">
                                <option value="">ทั้งหมด</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ช่วงวันที่</label>
                            <input type="date" class="form-input" id="auditDateFrom" onchange="loadAuditTrail()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ถึงวันที่</label>
                            <input type="date" class="form-input" id="auditDateTo" onchange="loadAuditTrail()">
                        </div>
                    </div>

                    <div id="auditTrailContent">
                        <div style="text-align: center; padding: 40px; color: #6c757d;">กำลังโหลดประวัติการเปลี่ยนแปลง...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="assign-modal" id="assignModal">
        <div class="assign-modal-content">
            <h3 class="section-title" style="border: none; padding-bottom: 0;">จ่ายงานลูกค้า</h3>
            <div id="assignCustomerInfo" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;"></div>
            <div class="form-group">
                <label class="form-label">จ่ายให้เซลล์</label>
                <select class="form-select" id="assignToSales">
                    <option value="">-- เลือกเซลล์ --</option>
                    <option value="MAM">MAM</option>
                    <option value="AU">AU</option>
                    <option value="GOLF">GOLF</option>
                    <option value="Online">Online</option>
                </select>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label class="form-label">หมายเหตุการจ่ายงาน</label>
                <textarea class="form-input" id="assignNote" rows="3" placeholder="เหตุผลในการจ่ายงาน..." maxlength="500"></textarea>
            </div>
            <div style="text-align: center; margin-top: 20px; display:flex; gap: 10px;">
                <button class="btn-primary" onclick="confirmAssignWork()" style="flex:1;">ยืนยัน</button>
                <button class="btn-secondary" onclick="closeAssignModal()" style="flex:1;">ยกเลิก</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // =====================================================
        // Global Variables
        // =====================================================
        let supabase = null;
        let currentUser = null;
        let currentProfile = null;
        let customers = [];
        let customerStatuses = [];
        let currentAssignCustomerId = null;
        let currentPage = 1;
        let totalPages = 1;
        let totalRecords = 0;
        let pageSize = 50;
        let lastSubmitTime = 0;
        let searchTimeout = null;
        let auditTrail = [];
        let sessionTimer = null;
        let sessionWarningTimer = null;

        // Excel editing variables with improved conflict resolution
        let editingCell = null;
        let originalValue = null;
        let editingCustomerId = null;
        let editingField = null;
        let isEditingInProgress = false;
        let editingTimeout = null;
        let editingSessionId = null;
        let editLock = false;

        // Status workflow configuration
        const STATUS_WORKFLOW = {
            1: 2, 
            2: 3, 
            3: 4, 
            4: 5  
        };

        // Editable fields configuration
        const EDITABLE_FIELDS = {
            0: { field: 'customer_code', type: 'text', label: 'รหัสลูกค้า' },
            1: { field: 'name', type: 'text', label: 'ชื่อลูกค้า' },
            2: { field: 'phone', type: 'tel', label: 'เบอร์โทร' },
            3: { field: 'procedure_type', type: 'select', label: 'ประเภทหัตถการ', 
                 options: ['ปลูกผม', 'ตาทีมแพทย์', 'จมูก', 'ยกคิ้ว', 'ฉีดผิว'] },
            4: { field: 'deposit', type: 'number', label: 'มัดจำ' },
            5: { field: 'status', type: 'select', label: 'สถานะ', options: 'status_list' },
            6: { field: 'note', type: 'textarea', label: 'หมายเหตุ'},
            7: { field: 'appointment_date', type: 'date', label: 'วันนัดหมาย' },
            8: { field: 'sales_person', type: 'select', label: 'เซลล์',
                 options: ['MAM', 'AU', 'GOLF', 'Online'] }
        };

        // Permissions configuration
        const PERMISSIONS = {
            Administrator: {
                canViewAll: true,
                canAssignWork: true,
                canManageDeposits: true,
                canAccessReports: true,
                canArchiveCustomers: true,
                canDeleteCustomers: true,
                canViewAuditTrail: true,
                displayName: 'ผู้ดูแลระบบ'
            },
            Admin: {
                canViewAll: false,
                canAssignWork: true,
                canManageDeposits: true,
                canAccessReports: true,
                canArchiveCustomers: true,
                canDeleteCustomers: false,
                canViewAuditTrail: true,
                displayName: 'ผู้จัดการ'
            },
            Sales: {
                canViewAll: false,
                canAssignWork: false,
                canManageDeposits: true,
                canAccessReports: false,
                canArchiveCustomers: false,
                canDeleteCustomers: false,
                canViewAuditTrail: false,
                displayName: 'เซลล์'
            }
        };

        // =====================================================
        // Utility Functions
        // =====================================================
        function getBangkokTime() {
            const now = new Date();
            const bangkokTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Bangkok"}));
            return bangkokTime.toISOString().slice(0, 19) + '+07:00';
        }

        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            // Enhanced input sanitization
            const div = document.createElement('div');
            div.textContent = input.trim();
            return div.innerHTML;
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchCustomers();
            }, 500); // Increased debounce time for better performance
        }

        function isOnline() {
            return navigator.onLine;
        }

        function showOfflineIndicator() {
            document.getElementById('offlineIndicator').style.display = isOnline() ? 'none' : 'block';
        }

        // Enhanced generateCustomerCode with uniqueness check
        async function generateCustomerCode() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            let code;
            let isUnique = false;
            let attempts = 0;
            const maxAttempts = 10;
            
            while (!isUnique && attempts < maxAttempts) {
                const randomNum = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
                code = `BC${year}${month}${day}-${randomNum}`;
                
                try {
                    const { data, error } = await supabase
                        .from('customers')
                        .select('id')
                        .eq('customer_code', code)
                        .single();
                        
                    if (error && error.code === 'PGRST116') {
                        // No matching record found, code is unique
                        isUnique = true;
                    }
                } catch (error) {
                    console.error('Error checking code uniqueness:', error);
                    isUnique = true; // Assume unique to proceed
                }
                
                attempts++;
            }
            
            // Fallback to timestamp if all attempts failed
            if (!isUnique) {
                code = `BC${year}${month}${day}-${Date.now().toString().slice(-4)}`;
            }
            
            return code;
        }

        // =====================================================
        // Session Management
        // =====================================================
        function startSessionTimer() {
            clearTimeout(sessionTimer);
            clearTimeout(sessionWarningTimer);
            
            // Show warning after 25 minutes
            sessionWarningTimer = setTimeout(() => {
                document.getElementById('sessionWarning').style.display = 'block';
            }, 25 * 60 * 1000);
            
            // Auto logout after 30 minutes
            sessionTimer = setTimeout(() => {
                showAlert('เซสชันหมดอายุ กรุณาเข้าสู่ระบบใหม่', 'warning');
                signOut();
            }, 30 * 60 * 1000);
        }

        function resetSessionTimer() {
            document.getElementById('sessionWarning').style.display = 'none';
            startSessionTimer();
        }

        // =====================================================
        // Enhanced Excel Editing with Race Condition Protection
        // =====================================================
        function startExcelEdit(cell, customerId, fieldIndex) {
            // Prevent concurrent edits
            if (editLock) {
                showAlert('กรุณารอให้การแก้ไขก่อนหน้าเสร็จสิ้น', 'warning', 2000);
                return;
            }
            
            // Cancel any existing edit first
            if (isEditingInProgress) {
                if (editingCell === cell) {
                    return; // Already editing this cell
                }
                // Save current edit before starting new one
                saveExcelEdit();
            }

            const fieldConfig = EDITABLE_FIELDS[fieldIndex];
            if (!fieldConfig) return;

            // Set up new editing session
            editLock = true;
            editingSessionId = Date.now() + Math.random();
            editingCell = cell;
            editingCustomerId = customerId;
            editingField = fieldConfig.field;
            isEditingInProgress = true;
            
            originalValue = cell.textContent.trim();
            
            if (fieldConfig.field === 'status') {
                const customer = customers.find(c => c.id === customerId);
                originalValue = customer ? customer.status : '';
            }
            if (fieldConfig.field === 'deposit') {
                originalValue = originalValue.replace(/,/g, '');
            }

            cell.classList.add('editing');
            
            let inputElement;
            
            if (fieldConfig.type === 'select') {
                inputElement = document.createElement('select');
                inputElement.className = 'form-select';
                
                if (fieldConfig.options === 'status_list') {
                    customerStatuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status.id;
                        option.textContent = status.name;
                        option.selected = status.id == originalValue;
                        inputElement.appendChild(option);
                    });
                } else {
                    fieldConfig.options.forEach(optText => {
                        const option = document.createElement('option');
                        option.value = optText;
                        option.textContent = optText;
                        option.selected = optText === originalValue;
                        inputElement.appendChild(option);
                    });
                }
            } else if (fieldConfig.type === 'textarea') {
                inputElement = document.createElement('textarea');
                inputElement.className = 'form-input';
                inputElement.style.height = '60px';
                inputElement.style.resize = 'vertical';
                inputElement.value = originalValue;
            } else {
                inputElement = document.createElement('input');
                inputElement.type = fieldConfig.type;
                inputElement.className = 'form-input';
                inputElement.value = originalValue;
                
                // Add input constraints
                if (fieldConfig.type === 'tel') {
                    inputElement.pattern = '[0-9\\-\\+\\(\\)\\s]{9,15}';
                } else if (fieldConfig.type === 'number') {
                    inputElement.min = '0';
                    inputElement.max = '999999999';
                }
            }
            
            // Enhanced event listeners
            inputElement.addEventListener('blur', handleBlurEvent);
            inputElement.addEventListener('keydown', handleKeydownEvent);
            
            // Clear timeout on new input
            clearTimeout(editingTimeout);
            editingTimeout = setTimeout(() => {
                if (isEditingInProgress && editingCell) {
                    saveExcelEdit();
                }
            }, 30000); // Auto-save after 30 seconds

            cell.innerHTML = '';
            cell.appendChild(inputElement);
            inputElement.focus();
            
            if (inputElement.select) {
                inputElement.select();
            }
            
            editLock = false;
        }

        function handleBlurEvent(e) {
            // Delay to allow click events to process
            setTimeout(() => {
                if (isEditingInProgress && editingCell && !editingCell.contains(document.activeElement)) {
                    saveExcelEdit();
                }
            }, 200);
        }

        function handleKeydownEvent(e) {
            e.stopPropagation();
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                saveExcelEdit();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelExcelEdit();
            }
        }

        async function saveExcelEdit() {
            if (!isEditingInProgress || !editingCell) return;
            if (editLock) return; // Prevent concurrent saves
            
            editLock = true;
            const currentSessionId = editingSessionId;
            const inputElement = editingCell.querySelector('input, select, textarea');
            if (!inputElement) {
                editLock = false;
                return;
            }

            let newValue = inputElement.value.trim();

            // Validate and process input
            if (editingField === 'status') {
                newValue = parseInt(newValue);
            } else if (editingField === 'deposit') {
                newValue = parseInt(newValue) || 0;
                if (newValue < 0 || newValue > 999999999) {
                    showAlert('มัดจำต้องอยู่ระหว่าง 0-999,999,999 บาท', 'error');
                    editLock = false;
                    cancelExcelEdit();
                    return;
                }
            } else if (editingField === 'phone') {
                // Enhanced phone validation for Thai numbers
                const phonePattern = /^[0-9\-\s\+\(\)]{9,15}$/;
                const thaiMobilePattern = /^(08|09|06)\d{8}$/;
                const cleanPhone = newValue.replace(/[\-\s\(\)]/g, '');
                
                if (!phonePattern.test(newValue) && !thaiMobilePattern.test(cleanPhone)) {
                    showAlert('รูปแบบเบอร์โทรไม่ถูกต้อง', 'error');
                    editLock = false;
                    cancelExcelEdit();
                    return;
                }
            } else if (editingField === 'name') {
                if (newValue.length < 2 || newValue.length > 100) {
                    showAlert('ชื่อต้องมีความยาว 2-100 ตัวอักษร', 'error');
                    editLock = false;
                    cancelExcelEdit();
                    return;
                }
            }
            
            if (newValue.toString() === originalValue.toString()) {
                editLock = false;
                cancelExcelEdit();
                return;
            }

            // Check for duplicate phone numbers
            if (editingField === 'phone') {
                const duplicate = await checkPhoneExists(newValue, editingCustomerId);
                if (duplicate) {
                    const confirmed = confirm(`เบอร์โทรนี้มีในระบบแล้ว (ลูกค้า: ${duplicate.name})\nต้องการดำเนินการต่อหรือไม่?`);
                    if (!confirmed) {
                        editLock = false;
                        cancelExcelEdit();
                        return;
                    }
                }
            }
            
            const updateData = {
                [editingField]: newValue,
                updated_at: getBangkokTime(),
                updated_by: currentUser.id
            };
            
            // Auto-note for status changes with reason prompt
if (editingField === 'status') {
    const statusDef = getStatusById(newValue);

    // --- ส่วนที่เพิ่มเข้ามา ---
    // แสดงหน้าต่างให้กรอกเหตุผล
    const reason = prompt(`เปลี่ยนสถานะเป็น: "${statusDef.name}"\nกรุณาใส่รายละเอียด/เหตุผล:`);

    // ถ้าผู้ใช้ไม่กรอก หรือกดยกเลิก ให้ยกเลิกการแก้ไขทั้งหมด
    if (!reason || reason.trim() === '') {
        showAlert('ยกเลิกการเปลี่ยนแปลงสถานะเนื่องจากไม่ได้ใส่เหตุผล', 'warning');
        editLock = false; // ปลดล็อค
        cancelExcelEdit(); // ยกเลิกการแก้ไข
        return; // ออกจากฟังก์ชัน ไม่ต้องทำต่อ
    }
    // --- จบส่วนที่เพิ่มเข้ามา ---

    const currentDate = new Date().toLocaleDateString('th-TH');
    // สร้าง Note รูปแบบใหม่ที่มีทั้งสถานะและเหตุผล
    const statusNote = `สถานะ: ${statusDef.name} / ${currentDate}\n- เหตุผล: ${reason.trim()}`;

    const customer = customers.find(c => c.id === editingCustomerId);
    updateData.note = (customer.note || '') + `\n\n[${currentProfile.name}]\n${statusNote}`;
            }

            try {
                // Verify session is still active
                if (currentSessionId !== editingSessionId) {
                    showAlert('การแก้ไขถูกยกเลิกเนื่องจากมีการแก้ไขใหม่', 'warning');
                    editLock = false;
                    return;
                }

                const { error } = await supabase
                    .from('customers')
                    .update(updateData)
                    .eq('id', editingCustomerId);

                if (error) {
                    console.error('Save error:', error);
                    showAlert(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
                } else {
                    // Log the change
                    await logAuditTrail('UPDATE', editingCustomerId, editingField, originalValue, newValue);
                    
                    showAlert('บันทึกสำเร็จ!', 'success', 1500);
                    loadCustomers();
                    updateDashboard();
                }
            } catch (error) {
                console.error('Save error:', error);
                showAlert('เกิดข้อผิดพลาดในการบันทึก', 'error');
            } finally {
                editLock = false;
                resetExcelEditState();
            }
        }

        function cancelExcelEdit() {
            clearTimeout(editingTimeout);
            resetExcelEditState();
            loadCustomers();
        }

        function resetExcelEditState() {
            if (editingCell) {
                editingCell.classList.remove('editing');
            }
            editingCell = null;
            originalValue = null;
            editingCustomerId = null;
            editingField = null;
            isEditingInProgress = false;
            editingSessionId = null;
            editLock = false;
            clearTimeout(editingTimeout);
        }

        // =====================================================
        // Enhanced Validation Functions
        // =====================================================
        async function checkPhoneExists(phone, excludeId = null) {
            try {
                let query = supabase
                    .from('customers')
                    .select('id, name')
                    .eq('phone', phone)
                    .eq('is_archived', false);
                
                if (excludeId) {
                    query = query.neq('id', excludeId);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('Phone check error:', error);
                    return false;
                }
                
                return data && data.length > 0 ? data[0] : false;
            } catch (error) {
                console.error('Phone check error:', error);
                return false;
            }
        }

        async function checkEmailExists(email, excludeId = null) {
            try {
                let query = supabase
                    .from('profiles')
                    .select('id, name')
                    .eq('email', email);
                
                if (excludeId) {
                    query = query.neq('id', excludeId);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('Email check error:', error);
                    return false;
                }
                
                return data && data.length > 0;
            } catch (error) {
                console.error('Email check error:', error);
                return false;
            }
        }

        // =====================================================
        // Audit Trail Functions
        // =====================================================
        async function logAuditTrail(action, recordId, field, oldValue, newValue, details = null) {
            if (!currentUser || !currentProfile) return;
            
            try {
                const auditData = {
                    user_id: currentUser.id,
                    user_name: currentProfile.name,
                    action: action,
                    table_name: 'customers',
                    record_id: recordId,
                    field_name: field,
                    old_value: oldValue ? oldValue.toString() : null,
                    new_value: newValue ? newValue.toString() : null,
                    details: details,
                    ip_address: await getClientIP(),
                    timestamp: getBangkokTime()
                };

                const { error } = await supabase
                    .from('audit_trail')
                    .insert([auditData]);

                if (error) {
                    console.error('Audit trail error:', error);
                }
            } catch (error) {
                console.error('Audit trail error:', error);
            }
        }

        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        async function loadAuditTrail() {
            if (!PERMISSIONS[currentProfile.role].canViewAuditTrail) {
                document.getElementById('auditTrailContent').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #6c757d;">คุณไม่มีสิทธิ์เข้าถึงประวัติการเปลี่ยนแปลง</div>';
                return;
            }

            const loadingEl = document.getElementById('auditTrailContent');
            loadingEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">กำลังโหลดประวัติการเปลี่ยนแปลง...</div>';

            const userFilter = document.getElementById('auditUserFilter').value;
            const dateFrom = document.getElementById('auditDateFrom').value;
            const dateTo = document.getElementById('auditDateTo').value;

            try {
                let query = supabase
                    .from('audit_trail')
                    .select('timestamp, user_name, action, table_name, field_name, old_value, new_value, details')
                    .order('timestamp', { ascending: false })
                    .limit(100);

                if (userFilter) {
                    query = query.eq('user_id', userFilter);
                }
                if (dateFrom) {
                    query = query.gte('timestamp', dateFrom + 'T00:00:00Z');
                }
                if (dateTo) {
                    query = query.lte('timestamp', dateTo + 'T23:59:59Z');
                }

                const { data, error } = await query;

                if (error) {
                    console.error('Load audit trail error:', error);
                    loadingEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">เกิดข้อผิดพลาดในการโหลดประวัติการเปลี่ยนแปลง</div>';
                    return;
                }

                renderAuditTrail(data || []);
            } catch (error) {
                console.error('Load audit trail error:', error);
                loadingEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">เกิดข้อผิดพลาดในการโหลดประวัติการเปลี่ยนแปลง</div>';
            }
        }

        function renderAuditTrail(data) {
            const container = document.getElementById('auditTrailContent');
            
            if (data.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">ไม่มีประวัติการเปลี่ยนแปลง</div>';
                return;
            }

            let html = `
                <div class="table-responsive">
                <table class="styled-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>วันที่-เวลา</th>
                            <th>ผู้ใช้</th>
                            <th>การกระทำ</th>
                            <th>ข้อมูลที่เปลี่ยน</th>
                            <th>ค่าเดิม</th>
                            <th>ค่าใหม่</th>
                            <th>รายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            data.forEach(entry => {
                const timestamp = new Date(entry.timestamp).toLocaleString('th-TH');
                html += `
                    <tr>
                        <td>${timestamp}</td>
                        <td>${escapeHtml(entry.user_name)}</td>
                        <td><span style="color: ${entry.action === 'UPDATE' ? '#dc3545' : '#28a745'}; font-weight: 600;">${entry.action}</span></td>
                        <td>${escapeHtml(entry.table_name)} - ${escapeHtml(entry.field_name || '-')}</td>
                        <td>${escapeHtml(entry.old_value || '-')}</td>
                        <td>${escapeHtml(entry.new_value || '-')}</td>
                        <td>${escapeHtml(entry.details || '-')}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // =====================================================
        // Supabase Initialization
        // =====================================================
        async function initializeSupabase() {
            const supabaseUrl = document.getElementById('supabaseUrl').value.trim();
            const supabaseAnonKey = document.getElementById('supabaseAnonKey').value.trim();
            
            if (!supabaseUrl || !supabaseAnonKey) {
                showAlert('กรุณาใส่ Supabase URL และ Anon Key', 'error');
                return;
            }

            // Validate URL format
            try {
                new URL(supabaseUrl);
            } catch (e) {
                showAlert('รูปแบบ URL ไม่ถูกต้อง', 'error');
                return;
            }

            try {
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                
                // Use sessionStorage for better security
                sessionStorage.setItem('supabaseUrl', supabaseUrl);
                sessionStorage.setItem('supabaseAnonKey', supabaseAnonKey);
                
                await testConnection();
            } catch (error) {
                console.error('Supabase initialization error:', error);
                showAlert('เกิดข้อผิดพลาดในการเชื่อมต่อ Supabase', 'error');
            }
        }

        async function testConnection() {
            try {
                const { data, error } = await supabase.from('profiles').select('count', { count: 'exact', head: true });
                
                if (error) {
                    console.error('Connection test error:', error);
                    showAlert('ไม่สามารถเชื่อมต่อกับ Supabase ได้ - ตรวจสอบ SQL Schema', 'error');
                    return;
                }
                
                await loadCustomerStatuses();
                
                showAlert('เชื่อมต่อ Supabase สำเร็จ!', 'success');
                document.getElementById('setupGuide').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
                
                checkAuthState();
            } catch (error) {
                console.error('Connection error:', error);
                showAlert('เกิดข้อผิดพลาดในการทดสอบการเชื่อมต่อ', 'error');
            }
        }

        async function loadCustomerStatuses() {
            try {
                const { data, error } = await supabase
                    .from('customer_statuses')
                    .select('*')
                    .order('display_order');
                
                if (error || !data || data.length === 0) {
                    console.warn('Could not load statuses from Supabase. Using default fallback values.');
                    // Fallback to default statuses if there's an error
                    customerStatuses = [
                        { id: 1, name: 'ลีดใหม่', color: '#007bff', display_order: 1 },
                        { id: 2, name: 'ติดต่อแล้ว', color: '#ffc107', display_order: 2 },
                        { id: 3, name: 'สนใจ/นัดหมาย', color: '#fd7e14', display_order: 3 },
                        { id: 4, name: 'กำลังเจรจา', color: '#fd7e14', display_order: 4 },
                        { id: 5, name: 'ปิดการขาย', color: '#28a745', display_order: 5 },
                        { id: 6, name: 'ไม่สนใจ/ยกเลิก', color: '#dc3545', display_order: 6 }
                    ];
                } else {
                    customerStatuses = data;
                }
                
                updateStatusFilter();
                console.log('Loaded customer statuses:', customerStatuses);
            } catch (error) {
                console.error('Error loading customer statuses:', error);
                // Fallback to default statuses if there's an error
                customerStatuses = [
                    { id: 1, name: 'ลีดใหม่', color: '#007bff', display_order: 1 },
                    { id: 2, name: 'ติดต่อแล้ว', color: '#ffc107', display_order: 2 },
                    { id: 3, name: 'สนใจ/นัดหมาย', color: '#fd7e14', display_order: 3 },
                    { id: 4, name: 'กำลังเจรจา', color: '#fd7e14', display_order: 4 },
                    { id: 5, name: 'ปิดการขาย', color: '#28a745', display_order: 5 },
                    { id: 6, name: 'ไม่สนใจ/ยกเลิก', color: '#dc3545', display_order: 6 }
                ];
                updateStatusFilter();
            }
        }

        function getStatusById(statusId) {
            return customerStatuses.find(s => s.id === statusId) || 
                   { id: statusId, name: 'ไม่ทราบ', color: '#6c757d' };
        }

        function updateStatusFilter() {
            const filterStatus = document.getElementById('filterStatus');
            if (filterStatus) {
                filterStatus.innerHTML = '<option value="">ทั้งหมด</option>';
                
                customerStatuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.id;
                    option.textContent = status.name;
                    filterStatus.appendChild(option);
                });
            }
        }

        // =====================================================
        // Enhanced Authentication Functions
        // =====================================================
        async function signUp() {
            const email = document.getElementById('signupEmail').value.trim();
            const name = document.getElementById('signupName').value.trim();
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('signupRole').value;
            const salesCode = document.getElementById('signupSalesCode').value;

            // Clear previous errors
            clearFormErrors();

            let hasErrors = false;

            if (!email || !isValidEmail(email)) {
                showFieldError('emailError', 'กรุณาใส่อีเมลที่ถูกต้อง');
                hasErrors = true;
            }

            if (!name || name.length < 2 || name.length > 50) {
                showFieldError('nameError', 'กรุณาใส่ชื่อที่มีอย่างน้อย 2-50 ตัวอักษร');
                hasErrors = true;
            }

            if (!password || password.length < 6) {
                showFieldError('passwordError', 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                hasErrors = true;
            }

            if (hasErrors) return;

            // Check for existing email
            const emailExists = await checkEmailExists(email);
            if (emailExists) {
                showFieldError('emailError', 'อีเมลนี้มีในระบบแล้ว');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: name,
                            role: role,
                            sales_code: salesCode
                        }
                    }
                });

                if (error) {
                    console.error('Signup error:', error);
                    showAlert('เกิดข้อผิดพลาด: ' + error.message, 'error');
                    return;
                }

                if (data && data.user) {
                    await logAuditTrail('CREATE_USER', data.user.id, 'user_registration', null, email, `New user: ${name}, Role: ${role}`);
                    showAlert('สร้างบัญชีสำเร็จ! กรุณาเข้าสู่ระบบ', 'success');
                    showSignIn();
                } else {
                    showAlert('สร้างบัญชีไม่สำเร็จ', 'error');
                }
                
            } catch (error) {
                console.error('Signup error:', error);
                showAlert('เกิดข้อผิดพลาดในการสร้างบัญชี', 'error');
            }
        }

        async function signIn() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAlert('กรุณากรอกอีเมลและรหัสผ่าน', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    console.error('Signin error:', error);
                    if (error.message.includes('Invalid login credentials')) {
                        showAlert('อีเมลหรือรหัสผ่านไม่ถูกต้อง', 'error');
                    } else {
                        showAlert('เกิดข้อผิดพลาด: ' + error.message, 'error');
                    }
                    return;
                }
                
                if (data && data.user) {
                    currentUser = data.user;
                    await loadUserProfile();
                    await logAuditTrail('LOGIN', currentUser.id, 'user_login', null, email, 'User logged in');
                    startSessionTimer();
                    showMainApp();
                } else {
                    showAlert('การลงชื่อเข้าใช้ล้มเหลว', 'error');
                }
            } catch (error) {
                console.error('Signin error:', error);
                showAlert('เกิดข้อผิดพลาดในการเข้าสู่ระบบ', 'error');
            }
        }

        async function signOut() {
            try {
                if (currentUser) {
                    await logAuditTrail('LOGOUT', currentUser.id, 'user_logout', null, currentUser.email, 'User logged out');
                }
                
                await supabase.auth.signOut();
                currentUser = null;
                currentProfile = null;
                customers = [];
                
                // Clear timers
                clearTimeout(sessionTimer);
                clearTimeout(sessionWarningTimer);
                
                // Clear session storage
                sessionStorage.removeItem('supabaseUrl');
                sessionStorage.removeItem('supabaseAnonKey');
                
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
                showAlert('ออกจากระบบแล้ว', 'success');
            } catch (error) {
                console.error('Signout error:', error);
                showAlert('เกิดข้อผิดพลาดในการออกจากระบบ', 'error');
            }
        }

        async function checkAuthState() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                await loadUserProfile();
                startSessionTimer();
                showMainApp();
            } else {
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
            }
        }

        async function loadUserProfile() {
            if (!currentUser || !currentUser.id) {
                console.error('Profile load error: No current user or user ID found.');
                showAlert('ไม่สามารถโหลดโปรไฟล์ได้ กรุณาลองเข้าสู่ระบบใหม่', 'error');
                signOut();
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) {
                    console.error('Profile load error:', error);
                    showAlert('ไม่สามารถโหลดโปรไฟล์ได้', 'error');
                    return;
                }

                currentProfile = data;
                
                if (currentProfile) {
                    await supabase
                        .from('profiles')
                        .update({ 
                            last_login: getBangkokTime(),
                            last_ip: await getClientIP()
                        })
                        .eq('id', currentUser.id);
                }
                    
            } catch (error) {
                console.error('Profile load error:', error);
                showAlert('เกิดข้อผิดพลาดในการโหลดโปรไฟล์', 'error');
            }
        }

        function showSignUp() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            clearFormErrors();
        }

        function showSignIn() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            clearFormErrors();
        }

        function showMainApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            
            if (currentProfile) {
                document.getElementById('userDisplayText').textContent = `ผู้ใช้: ${currentProfile.name}`;
                document.getElementById('userRoleBadge').textContent = PERMISSIONS[currentProfile.role].displayName;
                
                setupUserInterface();
                loadCustomers();
                updateDashboard();
                loadAuditUsers();
            }
        }

        function setupUserInterface() {
            const permissions = PERMISSIONS[currentProfile.role];
            
            if (permissions.canViewAll || currentProfile.role === 'Admin') {
                document.getElementById('addLeadTab').style.display = 'flex';
            } else {
                document.getElementById('addLeadTab').style.display = 'none';
            }

            if(currentProfile.role === 'Sales') {
                document.getElementById('myWorkTab').style.display = 'flex';
            } else {
                document.getElementById('myWorkTab').style.display = 'none';
            }
            
            updateDashboardPermissions();
        }

        function updateDashboardPermissions() {
            const permissions = PERMISSIONS[currentProfile.role];
            const statsGrid = document.getElementById('statsGrid');
            const quickActions = document.getElementById('quickActionButtons');
            
            statsGrid.innerHTML = '';
            quickActions.innerHTML = '';
            
            if (permissions.canViewAll) {
                addStatCard('ลูกค้าทั้งหมด', 'totalCustomers', '#17a2b8');
                addStatCard('ลูกค้าใหม่วันนี้', 'todayLeads', '#28a745');
            }
            
            addStatCard('เกินกำหนดติดตาม', 'overdueLeads', '#dc3545');
            
            if (permissions.canAccessReports) {
                addStatCard('ยอดขายเดือนนี้', 'monthlySales', '#28a745');
                addStatCard('อัตราปิดการขาย', 'conversionRate', '#17a2b8');
            }
            
            if (permissions.canViewAll || currentProfile.role === 'Admin') {
                addQuickAction('เพิ่มลูกค้าใหม่', 'showTab("add-lead")', 'btn-primary');
            }
            
            addQuickAction('จัดการลูกค้า', 'showTab("customers")', 'btn-secondary');
            
            if (permissions.canAccessReports) {
                addQuickAction('ดูรายงาน', 'showTab("reports")', 'btn-secondary');
            }
            
            addQuickAction('ส่งออกข้อมูล', 'exportData()', 'btn-secondary');
        }

        function addStatCard(title, id, color) {
            const card = document.createElement('div');
            card.className = 'stat-card';
            card.innerHTML = `
                <div>${title}</div>
                <div class="stat-value" id="${id}">0</div>
                <div style="color: ${color}; min-height: 1em;"></div>
            `;
            document.getElementById('statsGrid').appendChild(card);
        }

        function addQuickAction(title, onclick, className) {
            const button = document.createElement('button');
            button.className = className;
            button.textContent = title;
            button.onclick = new Function(onclick);
            document.getElementById('quickActionButtons').appendChild(button);
        }

        // =====================================================
        // Enhanced Lead Submission with Rate Limiting
        // =====================================================
        async function submitLead(event) {
            event.preventDefault();

            // Rate limiting
            const now = Date.now();
            if (now - lastSubmitTime < 3000) {
                showAlert('กรุณารอสักครู่ก่อนส่งข้อมูลใหม่', 'warning');
                return;
            }
            lastSubmitTime = now;

            // Clear previous errors
            clearFormErrors();

            const formData = {
                customer_code: await generateCustomerCode(),
                date: document.getElementById('leadDate').value,
                time: document.getElementById('leadTime').value,
                name: sanitizeInput(document.getElementById('customerName').value.trim()),
                phone: sanitizeInput(document.getElementById('customerPhone').value.trim()),
                channel: document.getElementById('leadChannel').value,
                procedure_type: document.getElementById('procedureType').value,
                sales_person: document.getElementById('salesPerson').value,
                status: 1,
                deposit: parseInt(document.getElementById('initialDeposit').value) || 0,
                note: sanitizeInput(document.getElementById('leadNote').value.trim()),
                created_by: currentUser.id,
                created_at: getBangkokTime(),
                next_follow_up: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                is_archived: false
            };

            const validation = await validateLeadForm(formData);
            if (!validation.isValid) {
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'กำลังบันทึก...';
            }

            try {
                const { data, error } = await supabase
                    .from('customers')
                    .insert([formData])
                    .select();

                if (error) {
                    console.error('Insert error:', error);
                    if (error.code === '23505') {
                        showAlert('เบอร์โทรศัพท์นี้มีในระบบแล้ว', 'error');
                    } else {
                        showAlert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message, 'error');
                    }
                    return;
                }

                await logAuditTrail('CREATE', data[0].id, 'new_customer', null, formData.name, `New customer created: ${formData.name}`);

                showAlert(`บันทึกข้อมูล "${formData.name}" สำเร็จ!`, 'success');
                resetForm();
                loadCustomers();
                updateDashboard();
            } catch (error) {
                console.error('Submit error:', error);
                showAlert('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'บันทึกข้อมูล';
                }
            }
        }

        async function validateLeadForm(data) {
            let isValid = true;

            if (!data.name || data.name.length < 2 || data.name.length > 100) {
                showFieldError('nameError', 'กรุณาใส่ชื่อที่ถูกต้อง (2-100 ตัวอักษร)');
                isValid = false;
            }

            // Enhanced phone validation for Thai numbers
            const phonePattern = /^[0-9\-\s\+\(\)]{9,15}$/;
            const thaiMobilePattern = /^(08|09|06)\d{8}$/;
            const cleanPhone = data.phone.replace(/[\-\s\(\)]/g, '');
            
            if (!phonePattern.test(data.phone) && !thaiMobilePattern.test(cleanPhone)) {
                showFieldError('phoneError', 'กรุณาใส่เบอร์ที่ถูกต้อง (เช่น 081-234-5678)');
                isValid = false;
            } else {
                // Check for duplicate phone
                const duplicate = await checkPhoneExists(data.phone);
                if (duplicate) {
                    showFieldError('phoneError', `เบอร์นี้ใช้โดย: ${duplicate.name}`);
                    isValid = false;
                }
            }

            if (!data.date || new Date(data.date) > new Date()) {
                showFieldError('dateError', 'วันที่ไม่ถูกต้องหรือเป็นอนาคต');
                isValid = false;
            }

            if (data.deposit < 0 || data.deposit > 999999999) {
                showFieldError('depositError', 'มัดจำต้องอยู่ระหว่าง 0-999,999,999 บาท');
                isValid = false;
            }

            return { isValid, data };
        }

        function showFieldError(fieldId, message) {
            const errorElement = document.getElementById(fieldId);
            const inputElement = errorElement ? errorElement.previousElementSibling : null;
            
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            if (inputElement) {
                inputElement.classList.add('error');
            }
        }

        function clearFormErrors() {
            const errorElements = document.querySelectorAll('.form-error');
            const inputElements = document.querySelectorAll('.form-input.error, .form-select.error');
            
            errorElements.forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });
            
            inputElements.forEach(el => {
                el.classList.remove('error');
            });
        }

        function isValidEmail(email) {
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailPattern.test(email);
        }

        // =====================================================
        // Enhanced Customer Loading with Pagination
        // =====================================================
        async function loadCustomers(page = 1) {
            if (!currentProfile) return;
            
            currentPage = page;
            const offset = (page - 1) * pageSize;
            
            const loadingEl = document.getElementById('customersLoading');
            if(loadingEl) loadingEl.classList.add('active');
            
            try {
                let query = supabase
                    .from('customers')
                    .select('*', { count: 'exact' })
                    .eq('is_archived', false)
                    .order('created_at', { ascending: false })
                    .range(offset, offset + pageSize - 1);

                // Apply permissions filter
                if (!PERMISSIONS[currentProfile.role].canViewAll) {
                    if (currentProfile.role === 'Admin') {
                        query = query.or(`status.eq.1,sales_person.eq.${currentProfile.sales_code || 'none'}`);
                    } else {
                        query = query.eq('sales_person', currentProfile.sales_code || 'none');
                    }
                }

                // Apply search filter
                const searchTerm = document.getElementById('searchCustomer')?.value.trim();
                if (searchTerm) {
                    query = query.or(`name.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%,customer_code.ilike.%${searchTerm}%`);
                }

                // Apply other filters
                const salesFilter = document.getElementById('filterSales')?.value;
                if (salesFilter) {
                    query = query.eq('sales_person', salesFilter);
                }

                const statusFilter = document.getElementById('filterStatus')?.value;
                if (statusFilter) {
                    query = query.eq('status', parseInt(statusFilter));
                }

                const channelFilter = document.getElementById('filterChannel')?.value;
                if (channelFilter) {
                    query = query.eq('channel', channelFilter);
                }

                const dateFrom = document.getElementById('filterDateFrom')?.value;
                if (dateFrom) {
                    query = query.gte('date', dateFrom);
                }

                const dateTo = document.getElementById('filterDateTo')?.value;
                if (dateTo) {
                    query = query.lte('date', dateTo);
                }

                const { data, error, count } = await query;

                if (error) {
                    console.error('Load customers error:', error);
                    showAlert('ไม่สามารถโหลดข้อมูลลูกค้าได้', 'error');
                    return;
                }

                customers = data || [];
                totalRecords = count || 0;
                totalPages = Math.ceil(totalRecords / pageSize);
                
                renderModernTable(customers);
                updatePaginationControls();
                
                // Reset session timer on activity
                resetSessionTimer();
            } catch (error) {
                console.error('Load customers error:', error);
                showAlert('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
            } finally {
                if(loadingEl) loadingEl.classList.remove('active');
            }
        }

        function updatePaginationControls() {
            document.getElementById('currentPageSpan').textContent = currentPage;
            document.getElementById('totalPagesSpan').textContent = totalPages;
            document.getElementById('totalRecordsSpan').textContent = totalRecords;

            document.getElementById('firstPage').disabled = currentPage === 1;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            document.getElementById('lastPage').disabled = currentPage === totalPages;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            loadCustomers(page);
        }

        function renderModernTable(data) {
            const tableBody = document.getElementById('customerTableBody');
            tableBody.innerHTML = '';

            if (data.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">ยังไม่มีข้อมูลลูกค้า</td>`;
                tableBody.appendChild(emptyRow);
                return;
            }

            const userPermissions = PERMISSIONS[currentProfile.role];

            data.forEach((customer, index) => {
                const row = document.createElement('tr');
                row.className = 'customer-row';
                row.onclick = (event) => {
                    // Prevent toggling when clicking on an editable cell or a button
                    if (event.target.classList.contains('editable') || event.target.closest('.action-buttons')) {
                        return;
                    }
                    toggleDetails(customer.id, row);
                };
                
                const statusDef = getStatusById(customer.status);
                
                let actionButtons = `<button title="ดู" onclick="viewCustomer('${customer.id}')" class="btn-action btn-view">👁</button>`;
                if (userPermissions.canAssignWork) actionButtons += `<button title="จ่ายงาน" onclick="openAssignModal('${customer.id}')" class="btn-action btn-assign">🔄</button>`;
                if (userPermissions.canArchiveCustomers) actionButtons += `<button title="เก็บ" onclick="archiveCustomer('${customer.id}')" class="btn-action btn-archive">📦</button>`;
                if (userPermissions.canDeleteCustomers) actionButtons += `<button title="ลบ" onclick="deleteCustomer('${customer.id}')" class="btn-action btn-delete">🗑</button>`;

                row.innerHTML = `
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 0)">${escapeHtml(customer.customer_code || 'BC-XXXX')}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 1)" style="font-weight: 600;">${escapeHtml(customer.name)}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 2)">${escapeHtml(customer.phone)}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 3)">${escapeHtml(customer.procedure_type)}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 4)">${(customer.deposit || 0).toLocaleString()}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 5)">
                        <span class="status-badge" style="background-color:${statusDef.color}; color: ${statusDef.color === '#ffc107' ? '#333' : 'white'}">${statusDef.name}</span>
                    </td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 7)">${escapeHtml(customer.appointment_date || '-')}</td>
                    <td class="editable" ondblclick="startExcelEdit(this, '${customer.id}', 8)">${escapeHtml(customer.sales_person)}</td>
                    <td>
                        <div class="action-buttons">${actionButtons}</div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function toggleDetails(customerId, rowElement) {
            // Remove any other open detail rows first
            const allDetailRows = document.querySelectorAll('.detail-row');
            allDetailRows.forEach(row => {
                if(row.id !== 'detail-' + customerId) {
                    row.remove();
                }
            });
            const allActiveRows = document.querySelectorAll('.active-row');
            allActiveRows.forEach(row => {
                if(row !== rowElement) {
                    row.classList.remove('active-row');
                }
            });

            const existingDetail = document.getElementById('detail-' + customerId);
            if (existingDetail) {
                existingDetail.remove();
                rowElement.classList.remove('active-row');
                return;
            }

            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const detailRow = document.createElement('tr');
            detailRow.id = 'detail-' + customerId;
            detailRow.className = 'detail-row';
            
            const detailCell = document.createElement('td');
            detailCell.colSpan = "9";
            detailCell.style.cssText = `
                background: #fdf5f6; 
                padding: 15px 25px; 
                white-space: normal;
                border-left: 3px solid #dc3545;
            `;
            
            detailCell.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong style="color: #dc3545;">ข้อมูลเพิ่มเติม:</strong><br>
                        <strong>ช่องทาง:</strong> ${escapeHtml(customer.channel || 'ไม่ระบุ')}<br>
                        <strong>วันที่สร้าง:</strong> ${new Date(customer.created_at).toLocaleDateString('th-TH')}<br>
                        <strong>อัปเดตล่าสุด:</strong> ${customer.updated_at ? new Date(customer.updated_at).toLocaleDateString('th-TH') : 'ไม่มี'}<br>
                        <strong>ติดตามครั้งถัดไป:</strong> ${customer.next_follow_up || 'ไม่ได้กำหนด'}
                    </div>
                    <div>
                        <strong style="color: #dc3545;">หมายเหตุทั้งหมด:</strong><br>
                        <pre style="font-family: inherit; margin: 0; white-space: pre-wrap; color: #495057; max-height: 100px; overflow-y: auto;">${escapeHtml(customer.note || 'ไม่มีหมายเหตุ')}</pre>
                    </div>
                </div>
            `;
            
            detailRow.appendChild(detailCell);
            rowElement.after(detailRow);
            rowElement.classList.add('active-row');
        }

        // =====================================================
        // Enhanced Search Functions
        // =====================================================
        function searchCustomers() {
            loadCustomers(1); // Reset to first page when searching
        }

        function toggleSearchFilters() {
            const filters = document.getElementById('searchFilters');
            const filterGrid = document.getElementById('filterGrid');
            const isCollapsed = filters.classList.contains('collapsed');
            
            if (isCollapsed) {
                filters.classList.remove('collapsed');
                filterGrid.style.display = 'grid';
            } else {
                filters.classList.add('collapsed');
                filterGrid.style.display = 'none';
            }
        }

        function clearFilters() {
            document.getElementById('searchCustomer').value = '';
            document.getElementById('filterSales').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterChannel').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            loadCustomers(1);
        }

        // =====================================================
        // Customer Management Functions
        // =====================================================
        async function archiveCustomer(customerId) {
            if (!confirm('ยืนยันการเก็บข้อมูลลูกค้านี้? (สามารถกู้คืนได้)')) {
                return;
            }

            const reason = prompt('เหตุผลในการเก็บข้อมูล:');
            if (!reason) return;

            try {
                const customer = customers.find(c => c.id === customerId);
                
                const { error } = await supabase
                    .from('customers')
                    .update({
                        is_archived: true,
                        archived_at: getBangkokTime(),
                        archived_by: currentUser.id,
                        archive_reason: reason
                    })
                    .eq('id', customerId);

                if (error) {
                    console.error('Archive customer error:', error);
                    showAlert('ไม่สามารถเก็บข้อมูลได้', 'error');
                    return;
                }

                await logAuditTrail('ARCHIVE', customerId, 'customer_archived', customer.name, 'archived', reason);

                showAlert('เก็บข้อมูลสำเร็จ', 'success');
                loadCustomers();
                updateDashboard();
            } catch (error) {
                console.error('Archive customer error:', error);
                showAlert('เกิดข้อผิดพลาดในการเก็บข้อมูล', 'error');
            }
        }

        async function deleteCustomer(customerId) {
            if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลลูกค้านี้? การกระทำนี้ไม่สามารถกู้คืนได้')) {
                return;
            }

            const finalConfirm = prompt('กรุณาพิมพ์ "DELETE" เพื่อยืนยันการลบ:');
            if (finalConfirm !== 'DELETE') {
                showAlert('การลบถูกยกเลิก', 'warning');
                return;
            }

            try {
                const customer = customers.find(c => c.id === customerId);
                
                const { error } = await supabase
                    .from('customers')
                    .delete()
                    .eq('id', customerId);

                if (error) {
                    console.error('Delete customer error:', error);
                    showAlert('ไม่สามารถลบข้อมูลได้', 'error');
                    return;
                }

                await logAuditTrail('DELETE', customerId, 'customer_deleted', customer.name, 'deleted', 'Customer permanently deleted');

                showAlert('ลบข้อมูลสำเร็จ', 'success');
                loadCustomers();
                updateDashboard();
            } catch (error) {
                console.error('Delete customer error:', error);
                showAlert('เกิดข้อผิดพลาดในการลบข้อมูล', 'error');
            }
        }

        function openAssignModal(customerId) {
            if (!PERMISSIONS[currentProfile.role].canAssignWork) {
                showAlert('คุณไม่มีสิทธิ์ในการจ่ายงาน', 'error');
                return;
            }

            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showAlert('ไม่พบข้อมูลลูกค้า', 'error');
                return;
            }

            currentAssignCustomerId = customerId;
            
            document.getElementById('assignCustomerInfo').innerHTML = `
                <strong>${escapeHtml(customer.name)}</strong><br>
                เบอร์: ${escapeHtml(customer.phone)}<br>
                หัตถการ: ${escapeHtml(customer.procedure_type)}<br>
                เซลล์ปัจจุบัน: <span style="color: #28a745; font-weight: 600;">${escapeHtml(customer.sales_person)}</span>
            `;

            document.getElementById('assignToSales').value = '';
            document.getElementById('assignNote').value = '';
            document.getElementById('assignModal').style.display = 'flex';
        }

        function closeAssignModal() {
            document.getElementById('assignModal').style.display = 'none';
            currentAssignCustomerId = null;
        }

        async function confirmAssignWork() {
            const newSales = document.getElementById('assignToSales').value;
            const assignNote = document.getElementById('assignNote').value.trim();

            if (!newSales) {
                showAlert('กรุณาเลือกเซลล์ที่จะจ่ายงานให้', 'warning');
                return;
            }

            if (!currentAssignCustomerId) {
                showAlert('เกิดข้อผิดพลาดในการจ่ายงาน', 'error');
                closeAssignModal();
                return;
            }

            try {
                const customer = customers.find(c => c.id === currentAssignCustomerId);
                if (!customer) {
                    showAlert('ไม่พบข้อมูลลูกค้า', 'error');
                    closeAssignModal();
                    return;
                }

                const oldSales = customer.sales_person;
                const assignRecord = `\n[${new Date().toLocaleDateString('th-TH')}] จ่ายงานจาก ${oldSales} ไปยัง ${newSales} โดย ${currentProfile.name}`;
                const updateNote = assignNote ? assignRecord + ` - หมายเหตุ: ${assignNote}` : assignRecord;

                const { error } = await supabase
                    .from('customers')
                    .update({
                        sales_person: newSales,
                        note: (customer.note || '') + updateNote,
                        updated_at: getBangkokTime(),
                        updated_by: currentUser.id
                    })
                    .eq('id', currentAssignCustomerId);

                if (error) {
                    console.error('Assign work error:', error);
                    showAlert('เกิดข้อผิดพลาดในการจ่ายงาน', 'error');
                    return;
                }

                await logAuditTrail('ASSIGN', currentAssignCustomerId, 'sales_person', oldSales, newSales, assignNote);

                showAlert(`จ่ายงาน "${customer.name}" จาก ${oldSales} ไปยัง ${newSales} สำเร็จ!`, 'success');
                closeAssignModal();
                loadCustomers();
            } catch (error) {
                console.error('Assign work error:', error);
                showAlert('เกิดข้อผิดพลาดในการจ่ายงาน', 'error');
            }
        }

        // =====================================================
        // Dashboard and Reports
        // =====================================================
        async function updateDashboard() {
            if (!currentProfile) return;

            try {
                const today = new Date().toISOString().split('T')[0];
                const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];

                const { count: totalCount } = await supabase.from('customers').select('*', { count: 'exact', head: true }).eq('is_archived', false);
                const { count: todayCount } = await supabase.from('customers').select('*', { count: 'exact', head: true }).eq('date', today);
                const { count: overdueCount } = await supabase.from('customers').select('*', { count: 'exact', head: true }).lt('created_at', new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString()).neq('status', 5).eq('is_archived', false);
                
                // Get sales analytics if available
                let monthlyRevenue = 0;
                let conversionRate = 0;
                
                try {
                    const { data: salesAnalytics } = await supabase.from('sales_analytics').select('*');
                    const { data: monthlyPerformance } = await supabase.from('monthly_performance').select('*').order('month', { ascending: false });
                    
                    if (monthlyPerformance && monthlyPerformance.length > 0) {
                        monthlyRevenue = monthlyPerformance.reduce((sum, item) => sum + (item.revenue || 0), 0);
                        const closedDealsThisMonth = monthlyPerformance.reduce((sum, item) => sum + (item.sales || 0), 0);
                        const totalLeadsThisMonth = monthlyPerformance.reduce((sum, item) => sum + (item.leads || 0), 0);
                        conversionRate = totalLeadsThisMonth > 0 ? Math.round((closedDealsThisMonth / totalLeadsThisMonth) * 100) : 0;
                    }
                } catch (error) {
                    console.log('Sales analytics not available');
                }

                const elements = {
                    'totalCustomers': totalCount || 0,
                    'todayLeads': todayCount || 0,
                    'overdueLeads': overdueCount || 0,
                    'monthlySales': formatCurrency(monthlyRevenue),
                    'conversionRate': `${conversionRate}%`
                };

                for (const [id, value] of Object.entries(elements)) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                }
                
                const overdueNotification = document.getElementById('overdueNotification');
                const overdueCountEl = document.getElementById('overdueCount');
                if (overdueCount > 0) {
                    overdueNotification.style.display = 'block';
                    overdueCountEl.textContent = overdueCount;
                } else {
                    overdueNotification.style.display = 'none';
                }
                
                if (customers.length > 0) {
                    updateRecentActivity();
                }

            } catch (error) {
                console.error('Update dashboard error:', error);
            }
        }

        function formatCurrency(amount) {
            if (amount === undefined || amount === null || isNaN(amount)) return '0';
            const num = parseFloat(amount);
            
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
            return num.toLocaleString();
        }

        function updateRecentActivity() {
            const recent = customers.slice().sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);
            const recentEl = document.getElementById('recentActivity');
            
            if (recent.length === 0) {
                recentEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">ยังไม่มีกิจกรรม</div>';
                return;
            }
            
            recentEl.innerHTML = '';
            recent.forEach(customer => {
                const statusDef = getStatusById(customer.status);
                
                const activityItem = document.createElement('div');
                activityItem.style.cssText = 'display: flex; align-items: center; gap: 15px; padding: 10px 0; border-bottom: 1px solid #f1f3f4;';
                
                activityItem.innerHTML = `
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #dc3545; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                        ${customer.name.charAt(0)}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${escapeHtml(customer.name)} - ${escapeHtml(customer.procedure_type)}</div>
                        <div style="font-size: 12px; color: #6c757d;">เบอร์: ${escapeHtml(customer.phone)} | เซลล์: ${escapeHtml(customer.sales_person)}</div>
                    </div>
                    <span style="font-size: 12px; color: ${statusDef.color}; font-weight: 600;">${statusDef.name}</span>
                `;
                recentEl.appendChild(activityItem);
            });
        }

        // =====================================================
        // Navigation and UI Functions
        // =====================================================
        function showTab(tabName) {
            const sections = document.querySelectorAll('.section');
            const tabs = document.querySelectorAll('.nav-tab');
            
            sections.forEach(section => section.classList.remove('active'));
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            
            const tabNames = {
                'dashboard': 'ภาพรวม',
                'customers': 'ลูกค้า', 
                'add-lead': 'เพิ่มลีด',
                'reports': 'รายงาน',
                'my-work': 'งานของฉัน',
                'alerts': 'แจ้งเตือน',
                'audit': 'ประวัติการเปลี่ยนแปลง'
            };
            
            const clickedTab = Array.from(tabs).find(tab => 
                tab.textContent.includes(tabNames[tabName])
            );
            
            if (clickedTab) clickedTab.classList.add('active');
            
            if (tabName === 'customers') loadCustomers();
            if (tabName === 'my-work') loadMyWork();
            if (tabName === 'reports') loadReports();
            if (tabName === 'alerts') loadAlerts();
            if (tabName === 'audit') loadAuditTrail();
            
            // Reset session timer on activity
            resetSessionTimer();
        }

        async function loadMyWork() {
            if (!currentProfile?.sales_code) {
                document.getElementById('myWorkTableBody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">คุณไม่มีรหัสเซลล์</td></tr>';
                return;
            }
            
            const myWorkBody = document.getElementById('myWorkTableBody');
            const myWork = customers.filter(customer => 
                customer.sales_person === currentProfile.sales_code && !customer.is_archived
            );
            
            myWorkBody.innerHTML = '';
            
            if (myWork.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">ยังไม่มีงานที่ได้รับมอบหมาย</td>`;
                myWorkBody.appendChild(emptyRow);
                return;
            }

            myWork.forEach((customer, index) => {
                const statusDef = getStatusById(customer.status);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${customer.date}</td>
                    <td style="font-weight: 600;">${escapeHtml(customer.name)}</td>
                    <td>${escapeHtml(customer.phone)}</td>
                    <td>${escapeHtml(customer.procedure_type)}</td>
                    <td><span class="status-badge" style="background-color:${statusDef.color}; color: ${statusDef.color === '#ffc107' ? '#333' : 'white'}">${statusDef.name}</span></td>
                    <td>${customer.next_follow_up || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="viewCustomer('${customer.id}')" class="btn-action btn-view">👁</button>
                            <button onclick="updateFollowUp('${customer.id}')" class="btn-action btn-assign">📅</button>
                        </div>
                    </td>
                `;
                myWorkBody.appendChild(row);
            });
        }

        async function loadReports() {
            if (!currentProfile || !PERMISSIONS[currentProfile.role].canAccessReports) {
                const reportEl = document.getElementById('reportContent');
                reportEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">คุณไม่มีสิทธิ์เข้าถึงรายงาน</div>';
                return;
            }

            const reportEl = document.getElementById('reportContent');
            reportEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">กำลังโหลดรายงาน...</div>';

            try {
                // Try to load from views if they exist
                let salesAnalytics = null;
                let monthlyPerformance = null;
                
                try {
                    const { data: sa } = await supabase.from('sales_analytics').select('*');
                    const { data: mp } = await supabase.from('monthly_performance').select('*').order('month', { ascending: false });
                    salesAnalytics = sa;
                    monthlyPerformance = mp;
                } catch (e) {
                    console.log('Analytics views not available, calculating from raw data');
                }

                // If views don't exist, calculate from raw data
                if (!salesAnalytics) {
                    // Calculate from customers table
                    const salesPeople = ['MAM', 'AU', 'GOLF', 'Online'];
                    salesAnalytics = [];
                    
                    for (const sp of salesPeople) {
                        const leads = customers.filter(c => c.sales_person === sp);
                        const closed = leads.filter(c => c.status === 5);
                        const revenue = closed.reduce((sum, c) => sum + (c.deposit || 0), 0);
                        
                        salesAnalytics.push({
                            sales_person: sp,
                            total_leads: leads.length,
                            closed_deals: closed.length,
                            total_revenue: revenue
                        });
                    }
                }

                if (!salesAnalytics || salesAnalytics.length === 0) {
                    reportEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">ยังไม่มีข้อมูลสำหรับรายงาน</div>';
                    return;
                }
                
                const totalLeads = salesAnalytics.reduce((sum, sp) => sum + sp.total_leads, 0);
                const totalClosed = salesAnalytics.reduce((sum, sp) => sum + sp.closed_deals, 0);
                const totalRevenue = salesAnalytics.reduce((sum, sp) => sum + sp.total_revenue, 0);
                const overallConversionRate = totalLeads > 0 ? Math.round((totalClosed / totalLeads) * 100) : 0;
                
                let salesReportHTML = `
                    <h3 class="section-title">รายงานรวมตามเซลล์</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                `;
                salesAnalytics.forEach(data => {
                    const rate = data.total_leads > 0 ? Math.round((data.closed_deals / data.total_leads) * 100) : 0;
                    salesReportHTML += `
                        <div class="stat-card">
                            <div style="font-weight: 600; color: #dc3545;">${escapeHtml(data.sales_person)}</div>
                            <div>ลีด: ${data.total_leads}</div>
                            <div>ปิดการขาย: ${data.closed_deals}</div>
                            <div>อัตรา: ${rate}%</div>
                            <div>รายได้: ${formatCurrency(data.total_revenue)} บาท</div>
                        </div>
                    `;
                });
                salesReportHTML += '</div>';

                let monthlyReportHTML = '';
                if (monthlyPerformance && monthlyPerformance.length > 0) {
                    monthlyReportHTML = `
                        <h3 class="section-title" style="margin-top: 30px;">ผลงานรายเดือน</h3>
                        <div class="table-responsive">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>เดือน</th>
                                    <th>เซลล์</th>
                                    <th>ลีด</th>
                                    <th>ปิดการขาย</th>
                                    <th>ยอดขาย (บาท)</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    monthlyPerformance.forEach(data => {
                        monthlyReportHTML += `
                            <tr>
                                <td>${new Date(data.month).toLocaleDateString('th-TH', { year: 'numeric', month: 'long' })}</td>
                                <td>${escapeHtml(data.sales_person)}</td>
                                <td>${data.leads}</td>
                                <td>${data.sales}</td>
                                <td>${(data.revenue || 0).toLocaleString()}</td>
                            </tr>
                        `;
                    });
                    monthlyReportHTML += '</tbody></table></div>';
                }
                
                reportEl.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div>ลีดรวมทั้งหมด</div>
                            <div class="stat-value">${totalLeads}</div>
                        </div>
                        <div class="stat-card">
                            <div>ปิดการขายสำเร็จ</div>
                            <div class="stat-value">${totalClosed}</div>
                            <div style="color: #28a745;">อัตรา ${overallConversionRate}%</div>
                        </div>
                        <div class="stat-card">
                            <div>ยอดขายรวมทั้งหมด</div>
                            <div class="stat-value">${formatCurrency(totalRevenue)}</div>
                            <div style="color: #dc3545;">บาท</div>
                        </div>
                    </div>
                    ${salesReportHTML}
                    ${monthlyReportHTML}
                `;
            } catch (error) {
                console.error('Load reports error:', error);
                reportEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">เกิดข้อผิดพลาดในการโหลดรายงาน</div>';
            }
        }

        async function loadAlerts() {
            if (!currentProfile) return;
            const alertsEl = document.getElementById('alertsList');
            alertsEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">กำลังโหลดการแจ้งเตือน...</div>';

            try {
                // Fetch overdue customers
                const { data: overdueCustomers, error } = await supabase
                    .from('customers')
                    .select('*')
                    .lt('created_at', new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString())
                    .neq('status', 5)
                    .eq('is_archived', false)
                    .order('created_at', { ascending: true });

                if (error) throw error;
                
                if (!overdueCustomers || overdueCustomers.length === 0) {
                    alertsEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">ไม่มีการแจ้งเตือน - ทุกอย่างเป็นไปด้วยดี! 🎉</div>';
                    return;
                }
                
                alertsEl.innerHTML = '<h3 style="color: #dc3545;">เกินกำหนดติดตาม (เกิน 45 วัน)</h3>' +
                    overdueCustomers.map(customer => {
                        const daysOld = Math.floor((new Date() - new Date(customer.created_at)) / (1000 * 60 * 60 * 24));
                        return `
                            <div style="background: #fff5f5; border-left: 4px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 4px;">
                                <div style="font-weight: 600; color: #dc3545;">${escapeHtml(customer.name)} - ${escapeHtml(customer.procedure_type)}</div>
                                <div style="font-size: 12px; color: #6c757d;">เบอร์: ${escapeHtml(customer.phone)} | เซลล์: ${escapeHtml(customer.sales_person)}</div>
                                <div style="font-size: 12px; color: #dc3545; margin-top: 5px;">⚠️ ค้าง ${daysOld} วัน</div>
                                <button onclick="viewCustomer('${customer.id}')" class="btn-primary" style="margin-top: 10px; padding: 5px 10px; font-size: 12px;">ดูรายละเอียด</button>
                            </div>
                        `;
                    }).join('');
            } catch (error) {
                console.error('Load alerts error:', error);
                alertsEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">เกิดข้อผิดพลาดในการโหลดการแจ้งเตือน</div>';
            }
        }

        async function loadAuditUsers() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, name')
                    .order('name');

                if (error) {
                    console.error('Load audit users error:', error);
                    return;
                }

                const userFilter = document.getElementById('auditUserFilter');
                if (userFilter) {
                    userFilter.innerHTML = '<option value="">ทั้งหมด</option>';
                    if (data) {
                        data.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.name;
                            userFilter.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Load audit users error:', error);
            }
        }

        function viewCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showAlert('ไม่พบข้อมูลลูกค้า', 'error');
                return;
            }
            
            const daysOld = Math.floor((new Date() - new Date(customer.created_at)) / (1000 * 60 * 60 * 24));
            const statusDef = getStatusById(customer.status);
            
            const details = 
                `รายละเอียดลูกค้า\n\n` +
                `ชื่อ: ${customer.name}\n` +
                `เบอร์: ${customer.phone}\n` +
                `วันที่: ${customer.date} ${customer.time}\n` +
                `ช่องทาง: ${customer.channel}\n` +
                `หัตถการ: ${customer.procedure_type}\n` +
                `เซลล์: ${customer.sales_person}\n` +
                `สถานะ: ${statusDef.name}\n` +
                `มัดจำ: ${(customer.deposit || 0).toLocaleString()} บาท\n` +
                `ยอดขาย: ${(customer.total_amount || 0).toLocaleString()} บาท\n` +
                `อายุข้อมูล: ${daysOld} วัน\n` +
                `วันที่ต้องติดตาม: ${customer.next_follow_up || 'ไม่ได้กำหนด'}\n` +
                `หมายเหตุ: ${customer.note || 'ไม่มี'}`;
            
            alert(details);
        }

        async function updateFollowUp(customerId) {
            const newDate = prompt('กำหนดวันที่ติดตามใหม่ (YYYY-MM-DD):');
            if (!newDate) return;
            
            // Validate date format
            const datePattern = /^\d{4}-\d{2}-\d{2}$/;
            if (!datePattern.test(newDate)) {
                showAlert('รูปแบบวันที่ไม่ถูกต้อง (ต้องเป็น YYYY-MM-DD)', 'error');
                return;
            }
            
            try {
                const customer = customers.find(c => c.id === customerId);
                
                const { error } = await supabase
                    .from('customers')
                    .update({ 
                        next_follow_up: newDate,
                        updated_at: getBangkokTime(),
                        updated_by: currentUser.id
                    })
                    .eq('id', customerId);

                if (error) {
                    console.error('Update follow-up error:', error);
                    showAlert('ไม่สามารถอัพเดทกำหนดการได้', 'error');
                    return;
                }

                await logAuditTrail('UPDATE', customerId, 'next_follow_up', customer.next_follow_up, newDate, 'Follow-up date updated');

                showAlert('อัพเดทกำหนดการติดตามสำเร็จ', 'success');
                loadMyWork();
            } catch (error) {
                console.error('Update follow-up error:', error);
                showAlert('เกิดข้อผิดพลาด', 'error');
            }
        }

        function showNotifications() {
            showTab('alerts');
        }

        function exportData() {
            try {
                const dataToExport = PERMISSIONS[currentProfile.role].canViewAll ? customers : 
                                   customers.filter(c => c.sales_person === currentProfile.sales_code);
                
                if (dataToExport.length === 0) {
                    showAlert('ไม่มีข้อมูลสำหรับส่งออก', 'warning');
                    return;
                }
                
                // Add BOM for Excel to recognize UTF-8
                const BOM = '\uFEFF';
                const csvHeader = 'วันที่,ชื่อ,เบอร์,ช่องทาง,หัตถการ,เซลล์,สถานะ,มัดจำ,ยอดขาย,หมายเหตุ\n';
                
                let csvContent = BOM + csvHeader;
                dataToExport.forEach(customer => {
                    const statusDef = getStatusById(customer.status);
                    const note = (customer.note || '').replace(/"/g, '""').replace(/\n/g, ' ');
                    csvContent += 
                        `${customer.date},"${customer.name}","${customer.phone}","${customer.channel}",` +
                        `"${customer.procedure_type}","${customer.sales_person}","${statusDef.name}",` +
                        `${customer.deposit || 0},${customer.total_amount || 0},"${note}"\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `beauty_clinic_data_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert(`ส่งออกข้อมูล ${dataToExport.length} รายการสำเร็จ!`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showAlert('เกิดข้อผิดพลาดในการส่งออกข้อมูล', 'error');
            }
        }

        function resetForm() {
            document.getElementById('leadForm').reset();
            clearFormErrors();
            
            const now = new Date();
            document.getElementById('leadDate').value = now.toISOString().split('T')[0];
            if (document.getElementById('leadTime')) {
                document.getElementById('leadTime').value = now.toTimeString().slice(0, 5);
            }
        }

        function showAlert(message, type = 'success', duration = 5000) {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;
            const alertId = 'alert-' + Date.now();
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.id = alertId;
            
            const messageEl = document.createElement('span');
            messageEl.textContent = message;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            };
            
            alert.appendChild(messageEl);
            alert.appendChild(closeBtn);
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                const el = document.getElementById(alertId);
                if (el && el.parentNode) el.parentNode.removeChild(el);
            }, duration);
        }

        // =====================================================
        // Event Listeners and Initialization
        // =====================================================
        window.onload = function() {
            // Check for saved credentials
            const savedUrl = sessionStorage.getItem('supabaseUrl');
            const savedKey = sessionStorage.getItem('supabaseAnonKey');
            
            if (savedUrl && savedKey) {
                document.getElementById('supabaseUrl').value = savedUrl;
                document.getElementById('supabaseAnonKey').value = savedKey;
                initializeSupabase();
            } else {
                document.getElementById('setupGuide').style.display = 'flex';
            }
            
            // Set default date and time
            const now = new Date();
            const leadDate = document.getElementById('leadDate');
            const leadTime = document.getElementById('leadTime');
            
            if (leadDate) leadDate.value = now.toISOString().split('T')[0];
            if (leadTime) leadTime.value = now.toTimeString().slice(0, 5);

            // Global click handler for Excel editing
            document.addEventListener('click', (e) => {
                if (isEditingInProgress && editingCell && !editingCell.contains(e.target)) {
                    if (!e.target.closest('button, a, select, input, .assign-modal')) {
                        setTimeout(() => {
                            if (isEditingInProgress && editingCell && !editingCell.querySelector('input:focus, select:focus, textarea:focus')) {
                                saveExcelEdit();
                            }
                        }, 100);
                    }
                }
            });

            // Global keydown handler for Excel editing
            document.addEventListener('keydown', (e) => {
                if (isEditingInProgress && (e.key === 'Enter' || e.key === 'Escape')) {
                    e.stopPropagation();
                }
            });

            // Handle modal clicks
            const assignModal = document.getElementById('assignModal');
            if (assignModal) {
                assignModal.addEventListener('click', (e) => {
                    if (e.target === assignModal) {
                        closeAssignModal();
                    }
                });
            }

            // Online/Offline detection
            window.addEventListener('online', () => {
                showOfflineIndicator();
                showAlert('กลับมาออนไลน์แล้ว', 'success', 2000);
            });
            
            window.addEventListener('offline', () => {
                showOfflineIndicator();
                showAlert('ขาดการเชื่อมต่ออินเทอร์เน็ต', 'warning');
            });
            
            showOfflineIndicator();

            // Activity tracking for session management
            document.addEventListener('mousemove', resetSessionTimer);
            document.addEventListener('keypress', resetSessionTimer);
        };

        // Supabase auth state listener
        if (typeof window.supabase !== 'undefined') {
            setTimeout(() => {
                if (supabase) {
                    supabase.auth.onAuthStateChange((event, session) => {
                        if (event === 'SIGNED_OUT') {
                            currentUser = null;
                            currentProfile = null;
                            customers = [];
                            document.getElementById('mainContainer').style.display = 'none';
                            document.getElementById('loginContainer').style.display = 'flex';
                        } else if (event === 'TOKEN_REFRESHED') {
                            resetSessionTimer();
                        }
                    });
                }
            }, 1000);
        }
    </script>
</body>
</html>
