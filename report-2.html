<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Funnel Analysis</title>
  <link rel="stylesheet" href="./report-2.css" />
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Sales Performance Analysis Report</h1>
      <p>Step 1: Funnel Analysis</p>
      <a href="./index.html" class="back-link">กลับหน้าหลัก (CRM)</a>
    </div>

    <div class="content-wrapper">
      <div class="content">

        <section class="section">
          
          <h2 class="section-title">2. Funnel Analysis (Overall)</h2>

          <h3 style="font-weight: 600; color: #764ba2; margin-top: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
            1. ป้อนข้อมูล (Inputs)
          </h3>
          <div class="stats-grid interactive-funnel funnel-section">

            <div class="stat-card input-card">
              <label class="stat-label" for="funnel-budget-input">Overall Budget (ใส่ตัวเลข)</label>
              <input
                type="number"
                class="stat-input"
                id="funnel-budget-input"
                value="0"
                step="1000"
                min="0"
              />
            </div>

            <div class="stat-card input-card">
              <label class="stat-label" for="funnel-inboxes-input">Total Inboxes (ลูกค้าทั้งหมด)</label>
              <input
                type="number"
                class="stat-input"
                id="funnel-inboxes-input"
                value="0"
                step="1"
                min="0"
              />
            </div>
          </div> <h3 style="font-weight: 600; color: #764ba2; margin-top: 30px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
            2. สรุปประสิทธิภาพ (Funnel Performance)
          </h3>
          <div class="stats-grid interactive-funnel funnel-section">

            <div class="stat-card display-card leads-card">
              <div class="stat-label">Qualified Leads (ตัวเลขจริง / เป้าหมาย)</div>
              <div class="value-comparison">
                <span class="actual-value" id="funnel-leads-actual">0</span>
                <span class="separator">/</span>
                <span class="target-value" id="funnel-leads-target">0</span>
              </div>
              <div class="target-note">(เป้าหมายคำนวณจาก 30% KPI)</div>
            </div>

            <div class="stat-card display-card sales-card">
              <div class="stat-label">Closed Sales (ตัวเลขจริง)</div>
              <div class="stat-value" id="funnel-sales-actual">0</div>
            </div>

            <div class="stat-card display-card">
              <div class="stat-label">Inbox-to-Lead Rate</div>
              <div class="stat-value" id="funnel-inbox-to-lead" style="color: var(--color-info);">0%</div>
              <div class="target-note">(Inboxes ➔ Qualified Leads)</div>
            </div>

            <div class="stat-card display-card">
              <div class="stat-label">Lead-to-Sale Rate</div>
              <div class="stat-value" id="funnel-lead-to-sale" style="color: var(--color-success);">0%</div>
              <div class="target-note">(Qualified Leads ➔ Closed Sales)</div>
            </div>

            <div class="stat-card display-card cpl-card">
              <div class="stat-label">Overall Cost Per Lead (คำนวณ)</div>
              <div class="stat-value" id="funnel-overall-cpl">0</div>
              <div class="target-note">(Budget / Qualified Leads)</div>
            </div>
            
            <div class="stat-card display-card cpl-card" style="border-top: 3px solid var(--color-success);">
              <div class="stat-label">Overall Cost Per Sale (คำนวณ)</div>
              <div class="stat-value" id="funnel-overall-cps" style="color: var(--color-success);">0</div>
              <div class="target-note">(Budget / Closed Sales)</div>
            </div>

          </div> </section>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
  <script src="./api.js"></script>

  <script>
    (async () => {
      // รอให้ config โหลดแป๊บนึง
      await new Promise(resolve => setTimeout(resolve, 50)); 
      if (window.supabaseClient) {
          const { data: { session } } = await window.supabaseClient.auth.getSession();
          if (!session) {
              // ถ้ายังไม่ Login ให้เด้งไปหน้า Login
              window.location.replace('./login.html'); 
          }
      } else {
          console.error("Supabase client not initialized for auth check.");
          alert("เกิดข้อผิดพลาดในการโหลด Supabase");
      }
    })();
  </script>

  <script src="./report-2.js"></script>
</body>
</html>
