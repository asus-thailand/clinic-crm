<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Funnel Analysis</title>
  <link rel="stylesheet" href="./report-2.css" />
  <style>
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background: #fff;
    }
    .excel-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .excel-table th, .excel-table td {
      border: 1px solid #e9ecef;
      padding: 12px 15px;
      text-align: left;
      white-space: nowrap;
    }
    .excel-table thead {
      background-color: #f8f9fa;
    }
    .excel-table thead th {
      font-weight: 600;
      color: #495057;
      vertical-align: middle;
    }
    .excel-table tbody tr:nth-child(even) {
      background-color: #fdfdfd;
    }
    .excel-table tbody tr:hover {
      background-color: #f1f3f5;
    }
    .subsection-title {
        font-size: 1.4em;
        color: #333;
        margin-top: 25px;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
    }
    
    /* [✅ SENIOR DEV EDIT] เพิ่ม CSS สำหรับ Toolbar ที่คัดลอกมา */
    .report-toolbar { 
      background: #fff; 
      padding: 15px 20px; 
      margin: 20px 0; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      display: flex; 
      flex-wrap: wrap; 
      align-items: center; 
      justify-content: space-between; 
      gap: 20px; 
    }
    .date-filter-group label { font-weight: 600; margin-right: 10px; color: #555; }
    .date-filter-group .btn-date-filter, .date-filter-group .date-input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
    .date-filter-group .btn-date-filter { background: #f0f0f0; cursor: pointer; }
    .date-filter-group .btn-date-filter.active { background: var(--color-primary); color: white; border-color: var(--color-primary); }
    .btn-apply-filter { background: var(--color-primary); color: white; border: none; padding: 9px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }

  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Sales Performance Analysis Report</h1>
      <p>Step 1: Funnel Analysis</p>
      <a href="./index.html" class="back-link">กลับหน้าหลัก (CRM)</a>
    </div>

    <section class="report-toolbar">
        <div class="date-filter-group">
            <label>ช่วงเวลา:</label>
            <button class="btn-date-filter" data-preset="7d">7 วัน</button>
            <button class="btn-date-filter" data-preset="30d">30 วัน</button>
            <button class="btn-date-filter active" data-preset="all">ทั้งหมด</button>
        </div>
        <div class="date-filter-group">
            <label>เลือกเอง:</label>
            <input type="date" id="startDateV2" class="date-input">
            <span>ถึง</span>
            <input type="date" id="endDateV2" class="date-input">
            <button id="applyFilterBtnV2" class="btn-apply-filter">แสดงผล</button>
        </div>
    </section>

    <div class="content-wrapper">
      <div class="content" id="report-content-v2"> <section class="section">
          <h2 class="section-title">2. Funnel Analysis (Overall)</h2>

          <div class="stats-grid interactive-funnel funnel-section">

            <div class="stat-card input-card">
              <label class="stat-label" for="funnel-budget-input">Overall Budget (ใส่ตัวเลข)</label>
              <input
                type="number"
                class="stat-input"
                id="funnel-budget-input"
                value="200000" step="1000"
                min="0"
              />
            </div>

            <div class="stat-card input-card">
              <label class="stat-label" for="funnel-inboxes-input">Total Inboxes (ลูกค้าทั้งหมด)</label>
              <input
                type="number"
                class="stat-input"
                id="funnel-inboxes-input"
                value="2000" step="1"
                min="0"
              />
            </div>

            <div class="stat-card display-card leads-card">
              <div class="stat-label">Qualified Leads (ตัวเลขจริง / เป้าหมาย)</div>
              
              <div class="value-comparison" id="funnel-leads-comparison">
                <span class="actual-value" id="funnel-leads-actual">0</span>
                <span class="separator">/</span>
                <span class="target-value" id="funnel-leads-target">0</span>
              </div>
              
              <div class="target-note" id="funnel-leads-percentage">(เป้าหมายคำนวณจาก 30% KPI)</div>
            </div>


            <div class="stat-card display-card sales-card">
              <div class="stat-label">Closed Sales (ตัวเลขจริง)</div>
              <div class="stat-value" id="funnel-sales-actual">0</div>
            </div>

            <div class="stat-card display-card cpl-card">
              <div class="stat-label">Overall Cost Per Lead (คำนวณ)</div>
              <div class="stat-value" id="funnel-overall-cpl">0</div>
            </div>

          </div>
        </section>
        
        <section class="section">
          <h2 class="section-title">3. Inbox to Consult</h2>

          <div class="stats-grid">
            <div class="stat-card display-card">
              <div class="stat-label">Qualified Leads (จาก Funnel)</div>
              <div class="stat-value" id="consult-qualified-leads">0</div>
            </div>

            <div class="stat-card display-card leads-card">
              <div class="stat-label">ยอดปิดการขาย (Actual)</div>
              <div class="value-comparison">
                <span class="actual-value" id="consult-2day-actual">0</span>
                <span class="separator">/</span>
                <span class="target-value" id="consult-2day-target">0</span>
              </div>
              <div class="target-note">(Actual / Target)</div>
            </div>
          </div>

          <h3 class="subsection-title">Breakdown by Sales (Consult 2 Day)</h3>
          <div class="table-wrapper">
              <table class="excel-table" style="min-width: 100%;">
                <thead>
                  <tr>
                    <th>ชื่อเซลล์</th>
                    <th>Qualified Leads</th>
                    <th>Consult 2 Day (Actual)</th>
                    <th>Target (90% KPI)</th>
                    <th>Achievement Rate</th>
                  </tr>
                </thead>
                <tbody id="consult-sales-breakdown-body">
                  <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
                </tbody>
              </table>
            </div>

        </section>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
  <script src="./api.js"></script>
  <script>
      (async () => {
          await new Promise(resolve => setTimeout(resolve, 50)); 
          if (window.supabaseClient) {
              const { data: { session } } = await window.supabaseClient.auth.getSession();
              if (!session) {
                  window.location.replace('./login.html');
              } else {
                  // [✅ EDIT] เก็บ user id ไว้ใน state เพื่อให้ report-2.js ใช้
                  if (!window.reportState) window.reportState = {};
                  window.reportState.currentUser = session.user;
              }
          } else {
              console.error("Supabase client not initialized for auth check in report-2.html.");
              alert("CRITICAL ERROR: Supabase connection failed.");
          }
      })();
  </script>
  <script src="./api-v2.js"></script>
  <script src="./report-2.js"></script>
</body>
</html>
