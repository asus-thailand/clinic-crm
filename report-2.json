// ================================================================================
// Sales Performance Dashboard - V2 SCRIPT
// [MODIFIED] Added Interactive "What-If" Financial Table (Section 6)
// This table links directly to the Scenario Planner (Section 7)
// ================================================================================

// -- GLOBAL STATE --
const state = {
    currentUser: null,
    reportData: null, // ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å API
    
    // [NEW] ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå HTML ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
    // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà API ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°
    financialData: [
        { month: '‡∏Å.‡∏Ñ.', budget: 194969, inbox: 1002, lead: 68, revenue: 1296726 },
        { month: '‡∏™.‡∏Ñ.', budget: 191843, inbox: 1060, lead: 73, revenue: 1631638 },
        { month: '‡∏Å.‡∏¢.', budget: 189435, inbox: 1172, lead: 67, revenue: 1366746 }
    ]
};

// -- HELPER FUNCTIONS --
function formatCurrency(n, showSign = false) {
    const num = parseFloat(n);
    if (isNaN(num)) return '-';
    const sign = num < 0 ? '-' : (showSign ? '+' : '');
    const abs = Math.abs(Math.round(num));
    return sign + '‡∏ø' + abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function formatNumber(n) {
     const num = parseFloat(n);
     if (isNaN(num)) return '0';
     return num.toLocaleString();
}

function displayError(error) {
    const mainContainer = document.querySelector('.container');
    if (mainContainer) {
        mainContainer.innerHTML = `<div style="text-align: center; padding: 40px; background: #fff; margin: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"><h2 style="color: #dc3545;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2><p>${error.message}</p></div>`;
    }
}

// ================================================================================
// [NEW] FINANCIAL TABLE LOGIC (SECTION 6)
// ================================================================================

/**
 * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì CPL ‡πÅ‡∏•‡∏∞ ROAS ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ (Row)
 */
function recalculateFinancialRow(rowElement) {
    const budget = parseFloat(rowElement.querySelector('.input-budget').value) || 0;
    const lead = parseFloat(rowElement.querySelector('.input-lead').value) || 0;
    const revenue = parseFloat(rowElement.querySelector('.input-revenue').value) || 0;

    const cpl = (lead > 0) ? (budget / lead) : 0;
    const roas = (budget > 0) ? (revenue / budget) : 0;

    rowElement.querySelector('.cell-cpl').textContent = formatCurrency(cpl);
    rowElement.querySelector('.cell-roas').textContent = `${roas.toFixed(2)}x`;
    
    // ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    return true; 
}

/**
 * [NEW] ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Footer ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Planner
 */
function updateFinancialTotals() {
    const tableBody = document.getElementById('financial-table-body');
    const rows = tableBody.querySelectorAll('tr');
    
    let totalBudget = 0;
    let totalInbox = 0;
    let totalLead = 0;
    let totalRevenue = 0;

    rows.forEach(row => {
        totalBudget += parseFloat(row.querySelector('.input-budget').value) || 0;
        totalInbox += parseFloat(row.querySelector('.input-inbox').value) || 0;
        totalLead += parseFloat(row.querySelector('.input-lead').value) || 0;
        totalRevenue += parseFloat(row.querySelector('.input-revenue').value) || 0;
    });

    const totalCPL = (totalLead > 0) ? (totalBudget / totalLead) : 0;
    const totalROAS = (totalBudget > 0) ? (totalRevenue / totalBudget) : 0;

    // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á Footer (Section 6)
    document.getElementById('total-budget').textContent = formatCurrency(totalBudget);
    document.getElementById('total-inbox').textContent = formatNumber(totalInbox);
    document.getElementById('total-lead').textContent = formatNumber(totalLead);
    document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
    document.getElementById('total-cpl').textContent = formatCurrency(totalCPL);
    document.getElementById('total-roas').textContent = `${totalROAS.toFixed(2)}x`;

    // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Stat Cards (Section 6)
    document.getElementById('financial-budget').textContent = formatCurrency(totalBudget);
    document.getElementById('financial-revenue').textContent = formatCurrency(totalRevenue);
    document.getElementById('financial-roas').textContent = `${totalROAS.toFixed(2)}x`;

    // 3. [THE LINK] ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á Planner (Section 7)
    const plannerInboxEl = document.getElementById('inboxes');
    if (plannerInboxEl) {
        plannerInboxEl.value = totalInbox;
    }
    
    // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Note ‡πÉ‡∏ô Planner
    const plannerNotes = document.getElementById('planner-notes');
    if (plannerNotes) {
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ % ‡∏à‡∏≤‡∏Å Planner ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        const inboxToLeadPercent = (totalInbox > 0) ? (totalLead / totalInbox * 100).toFixed(1) : 0;
        document.getElementById('inboxToLead').value = inboxToLeadPercent;
        document.getElementById('inboxToLeadValue').textContent = `${inboxToLeadPercent}%`;

        // (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ 'sales' ‡∏°‡∏≤‡∏à‡∏≤‡∏Å Lead * 28.6% ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Planner)
        const leadToSalePercent = parseFloat(document.getElementById('leadToSale').value) || 28.6;
        const totalSales = Math.round(totalLead * (leadToSalePercent / 100));
        
        plannerNotes.textContent = `* ‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á: Inbox ${formatNumber(totalInbox)} ‚Üí Lead ${formatNumber(totalLead)} ‚Üí Sale ${formatNumber(totalSales)}`;
    }

    // 5. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ Planner ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà
    if (typeof calcPlanner === 'function') {
        calcPlanner();
    }
}


/**
 * [MODIFIED] ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö Interactive
 */
function renderFinancials(financialData) {
    const tableBody = document.getElementById('financial-table-body');
    const tableFooter = document.getElementById('financial-table-footer');
    
    if (!financialData || financialData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</td></tr>';
        return;
    }
    
    tableBody.innerHTML = ''; // Clear loading
    
    financialData.forEach(month => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${month.month}</td>
            <td><input type="number" class="input-budget" value="${month.budget}"></td>
            <td><input type="number" class="input-inbox" value="${month.inbox}"></td>
            <td><input type="number" class="input-lead" value="${month.lead}"></td>
            <td><input type="number" class="input-revenue" value="${month.revenue}"></td>
            <td class="cell-calc cell-cpl">...</td>
            <td class="cell-calc cell-roas">...</td>
        `;
        tableBody.appendChild(tr);
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤ CPL/ROAS ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        recalculateFinancialRow(tr);
    });
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Footer
    tableFooter.innerHTML = `
        <tr>
            <td>Total</td>
            <td id="total-budget">...</td>
            <td id="total-inbox">...</td>
            <td id="total-lead">...</td>
            <td id="total-revenue">...</td>
            <td id="total-cpl">...</td>
            <td id="total-roas" class="good">...</td>
        </tr>
    `;
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Total ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    updateFinancialTotals();
    
    // [NEW] ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏ó‡∏µ‡πà "tbody" (Event Delegation)
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ô <input> ‡πÉ‡∏î‡πÜ ‡πÉ‡∏ô tbody...
    tableBody.addEventListener('input', (event) => {
        if (event.target.tagName === 'INPUT') {
            const row = event.target.closest('tr');
            recalculateFinancialRow(row); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
            updateFinancialTotals(); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        }
    });
}


// ================================================================================
// DATA RENDERING FUNCTIONS (V1 - Static)
// ================================================================================

// ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Funnel (‡∏à‡∏≤‡∏Å HTML ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
function renderFunnel() {
    document.getElementById('funnel-inboxes').textContent = formatNumber(3234);
    document.getElementById('funnel-leads').textContent = formatNumber(279);
    document.getElementById('funnel-sales').textContent = formatNumber(86);
}

// ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏° Performance (‡∏à‡∏≤‡∏Å HTML ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
function renderTeamPerformance() {
    const container = document.getElementById('team-performance-grid');
    container.innerHTML = ''; // Clear loading
    
    const teamData = [
        { name: "üíª ‡∏ó‡∏µ‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Online Team)", main_metric: "‡∏ø1,810,726", main_metric_label: "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (Total Revenue)", color: "#764ba2", analysis: "‡πÄ‡∏õ‡πá‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Lead ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (40 ‡πÄ‡∏Ñ‡∏™) ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏™‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ø45,268) ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô", metrics: [ { label: "‡∏¢‡∏≠‡∏î‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏Ñ‡∏™‡∏£‡∏µ‡∏ß‡∏¥‡∏ß x 40)", value: "‡∏ø1,599,960" }, { label: "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô", value: "‡∏ø210,766" } ] },
        { name: "üèÜ MAM (The Opener)", main_metric: "69.0%", main_metric_label: "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Closing Rate)", color: "#48bb78", analysis: "‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Lead ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (Opener) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î", metrics: [ { label: "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î", value: "29.0%" } ] },
        { name: "üí∞ AU (The Closer)", main_metric: "85.0%", main_metric_label: "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Closing Rate)", color: "#667eea", analysis: "‡∏Ñ‡∏∑‡∏≠‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏ô‡∏±‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Closer) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏õ‡∏¥‡∏î‡∏î‡∏µ‡∏•‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î", metrics: [ { label: "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î", value: "22.0%" } ] },
        { name: "üìà GOLF (Opportunity for Growth)", main_metric: "47.4%", main_metric_label: "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Closing Rate)", color: "#f56565", analysis: "‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢", metrics: [ { label: "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î", value: "21.3%" } ] }
    ];

    teamData.forEach(team => {
        const card = document.createElement('div');
        card.className = 'stat-card';
        card.style.borderTop = `5px solid ${team.color || '#ccc'}`;
        
        let metricsHtml = '';
        if(team.metrics) {
            team.metrics.forEach(metric => {
                metricsHtml += `<div class="metric-item"><span>- ${metric.label}</span> <span>${metric.value}</span></div>`;
            });
        }

        card.innerHTML = `
            <h3>${team.name}</h3>
            <div class="stat-value" style="color:${team.color || '#333'};">${team.main_metric}</div>
            <div class="stat-label">${team.main_metric_label}</div>
            ${metricsHtml}
            <p class="stat-subtext"><strong>Analysis:</strong> ${team.analysis}</p>
        `;
        container.appendChild(card);
    });
}

// ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
function renderRecommendations() {
    const list = document.getElementById('recommendations-list');
    list.innerHTML = `
        <li><strong>Individual Coaching for GOLF:</strong> ‡πÉ‡∏´‡πâ AU ‡∏™‡∏≠‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ MAM ‡∏™‡∏≠‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</li>
        <li><strong>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Lead Qualification):</strong> ONLINE ‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ AU ‡∏´‡∏£‡∏∑‡∏≠ MAM ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</li>
        <li><strong>‡∏™‡∏£‡πâ‡∏≤‡∏á Lead Cycle ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏î‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û:</strong> ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á</li>
    `;
}

// ‡πÄ‡∏ï‡∏¥‡∏° KPI
function renderKPIs() {
    document.getElementById('kpi-inbox-lead').textContent = "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 30%";
    document.getElementById('kpi-lead-appt').textContent = "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 90%";
    document.getElementById('kpi-revenue-goal').textContent = "‡∏ø6.5M";
}


// -- CORE LOGIC --
async function fetchAndRenderReport() {
    if (!state.currentUser) {
        console.error("No user found. Aborting fetch.");
        return;
    }
    
    try {
        // [NOTE] ‡πÄ‡∏£‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏à‡∏£‡∏¥‡∏á
        // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Static ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô state ‡πÅ‡∏•‡∏∞ HTML ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
        // const reportData = await api.getSalesReport(state.currentUser.id, null, null);
        // state.reportData = reportData; 
        
        // [NEW] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Render ‡πÉ‡∏´‡∏°‡πà
        renderFunnel();
        renderTeamPerformance();
        renderRecommendations();
        renderKPIs();
        
        // [MODIFIED] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö Interactive
        // ‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (state.financialData) ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        renderFinancials(state.financialData);

    } catch (error) {
        console.error("Failed to load report data:", error);
        displayError(error);
    }
}

// -- INITIALIZATION --
async function initializeApp() {
    // [MOCK] ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ User ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
    // const { data: { user } } = await window.supabaseClient.auth.getUser();
    const user = { id: 'mock-user' };
    
    if (user) {
        state.currentUser = user;
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞ Render ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        fetchAndRenderReport();
    } else {
        displayError(new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ, ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"));
    }
}

// Start the application once the DOM is fully loaded
document.addEventListener('DOMContentLoaded', initializeApp);


// ================================================================================
// SCENARIO PLANNER LOGIC (SECTION 7)
// ================================================================================

// (‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô window object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Reset ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ)
window.plannerBase = { 
    inboxes: 3234, 
    inboxToLead_percent: 8.6, 
    leadToSale_percent: 28.6, 
    avg_ticket_size: 54368, 
    target: 6500000 
};

// References to Planner elements
const targetEl = document.getElementById('target');
const inboxesEl = document.getElementById('inboxes');
const inboxToLeadEl = document.getElementById('inboxToLead');
const leadToSaleEl = document.getElementById('leadToSale');
const ticketEl = document.getElementById('ticket');
const inboxToLeadValue = document.getElementById('inboxToLeadValue');
const leadsOut = document.getElementById('leadsOut');
const salesOut = document.getElementById('salesOut');
const revenueOut = document.getElementById('revenueOut');
const gapOut = document.getElementById('gapOut');
const insightEl = document.getElementById('insight');

/**
 * [MODIFIED] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'calcPlanner' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥
 */
function calcPlanner() {
    const target = Number(targetEl.value) || 0;
    const inboxes = Number(inboxesEl.value) || 0;
    const inboxToLead = Number(inboxToLeadEl.value) || 0;
    const leadToSale = Number(leadToSaleEl.value) || 0;
    const ticket = Number(ticketEl.value) || 0;

    const leads = Math.round((inboxes * inboxToLead) / 100);
    const sales = Math.round((leads * leadToSale) / 100);
    const revenue = sales * ticket;
    const gap = revenue - target;

    leadsOut.textContent = leads.toLocaleString();
    salesOut.textContent = sales.toLocaleString();
    revenueOut.textContent = formatCurrency(revenue);
    gapOut.textContent = (gap >= 0 ? '+ ' : '') + formatCurrency(gap);

    gapOut.parentElement.classList.remove('positive', 'negative');
    gapOut.parentElement.classList.add(gap >= 0 ? 'positive' : 'negative');

    let insight = '';
    if (gap >= 0) {
        const revenueOver = formatCurrency(gap);
        insight = `‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤ ${revenueOver} üéâ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!`;
    } else {
        const missing = Math.abs(gap);
        const neededSales = (ticket > 0) ? Math.ceil(missing / ticket) : 0;
        const neededLeads = (leadToSale > 0) ? Math.ceil(neededSales / (leadToSale / 100)) : 0;
        const targetConversion = (inboxes > 0) ? (neededLeads * 100) / inboxes : 0;
        
        insight = `‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î <span class="planner-highlight">${formatCurrency(missing)}</span> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì <span class="planner-highlight">${neededSales}</span> ‡πÄ‡∏Ñ‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤ <br><br>
        ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤ ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° Conversion Rate ‡∏Ç‡∏≠‡∏á Inbox‚ÜíLead ‡πÄ‡∏õ‡πá‡∏ô <span class="planner-highlight">${targetConversion.toFixed(1)}%</span> ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° <span class="planner-highlight">${neededLeads}</span> Leads`;
    }
    insightEl.innerHTML = insight;
}

// --- Event Listeners for Planner (Section 7) ---
inboxToLeadEl.addEventListener('input', () => {
    inboxToLeadValue.textContent = `${inboxToLeadEl.value}%`;
    calcPlanner(); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Planner
    // [NEW] ‡∏ñ‡πâ‡∏≤‡πÅ‡∏Å‡πâ % ‡πÉ‡∏ô Planner ‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (Section 6) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Note
    updateFinancialTotals();
});

// [NEW] ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á Input ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á Planner ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Real-time ‡∏î‡πâ‡∏ß‡∏¢
inboxesEl.addEventListener('input', calcPlanner);
leadToSaleEl.addEventListener('input', calcPlanner);
ticketEl.addEventListener('input', calcPlanner);
targetEl.addEventListener('input', calcPlanner);

// ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ)
document.getElementById('calcBtn').addEventListener('click', calcPlanner);

// ‡∏õ‡∏∏‡πà‡∏° Reset
document.getElementById('resetBtn').addEventListener('click', () => {
    // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Base ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å API (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤ Default
    const base = window.plannerBase; 
    
    targetEl.value = base.target;
    inboxesEl.value = base.inboxes;
    inboxToLeadEl.value = base.inboxToLead_percent;
    leadToSaleEl.value = base.leadToSale_percent;
    ticketEl.value = base.avg_ticket_size;
    inboxToLeadValue.textContent = `${base.inboxToLead_percent}%`;
    
    // [MODIFIED] ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Reset Planner ‡πÉ‡∏´‡πâ Reset ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢
    renderFinancials(state.financialData); // ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞ re-calc ‡πÅ‡∏•‡∏∞ re-link planner ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
});

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤)
// (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô `renderFinancials` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ Total ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô)
// calcPlanner();